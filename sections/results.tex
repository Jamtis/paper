% !TEX root = ../paper.tex
\section{Technical Overview}
\label{sec:overview}


\subsection{Generic Constructions}

\begin{construction}\label{con:sel-to-ad}
    Let \(\PKE' = \parr{\Gen',\Enc',\Dec',\Punct'}\) be a tpPKE with message space \(M'_\secpar \coloneqq \bit^\secpar\) and tag space \(T'_\secpar \coloneqq \bit\).
    We define a new tpKEM scheme \(\PKE = \parr{\Gen,\Enc,\Dec,\Punct}\) with message space \(M_\secpar \coloneqq \bit^\secpar\) and tag space \(T_\secpar \coloneqq \bit^\secpar\) as follows:
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\):
        \begin{sitemize}
            \item sample \(\parr{\pk_1,\sk_1}, ..., \parr{\pk_1,\sk_1} \gets \Gen'\parr{1^\secpar}\),
            \item set \(\pk \coloneqq \parr{\pk_i}_{i \in \parc{1,...,\secpar}}\),
            \item set \(\sk \coloneqq \parr{\sk_i}_{i \in \parc{1,...,\secpar}}\),
            \item output \(\parr{\pk,\sk}\).
        \end{sitemize}

        \item \(\Enc\parr{\pk,m,t}\):
        \begin{sitemize}
            \item for each \(i \in \parc{1,...,\secpar}\) encrypt \(c_i \gets \Enc'\parr{\pk_i,m,t_i}\),
            \item output \(c \coloneqq \parr{c_i}_{i \in \parc{1,...,\secpar}}\).
        \end{sitemize}

        \item \(\Dec\parr{\sk,c}\):
        \begin{sitemize}
            \item parse \(\parr{c_i}_{i \in \parc{1,...,\secpar}} \coloneqq c\),
            \item for each \(i \in \parc{1,...,\secpar}\) decrypt \(\widetilde{m}_i \gets \Dec'\parr{\sk_i,c_i}\),
            \item if there are two inconsistent messages abort, i.e., \(\exists i \neq j : \widetilde{m}_i \neq \widetilde{m}_j\) output \(\bot\),
            \item output \(\widetilde{m}_1\).
        \end{sitemize}

        \item \(\Punct\parr{\sk,t'}\):
        \begin{sitemize}
            \item for each \(i \in \parc{1,...,\secpar}\) puncture \(\sk_i\pars{t'_i} \gets \Punct'\parr{\sk_i,t'_i}\),
            \item output \(\sk\pars{t'} \coloneqq \parr{\sk_i\pars{t'_i}}_{i \in \parc{1,...,\secpar}}\).
        \end{sitemize}

        \item \(\Dec\parr{\sk[t'],c}\):
        \begin{sitemize}
            \item parse \(\parr{c_i}_{i \in \parc{1,...,\secpar}} \coloneqq c\),
            \item for each \(i \in \parc{1,...,\secpar}\) decrypt \(\widetilde{m}_i \gets \Dec'\parr{\sk_i,c_i}\),
            \item let \(\ihat\) be the first index such that \(\widetilde{m}_\ihat \neq \bot\), if not such index exists output \(\bot\),
            \item output \(\widetilde{m}_\ihat\).
        \end{sitemize}
    \end{sitemize}
\end{construction}

\begin{theorem}[\(M\)-adaptive to fully-adaptive security]
    If \(\PKE'\) is an \(M\)-ad-IND-CPA/CTKL secure \(\parr{\alpha',\alpha'_{\textsf{PK}},\alpha'_{\textsf{DE}},\varepsilon',t'}\)-tpPKE with binary tag space where \(\alpha'_{\textsf{PK}}\parr{\secpar},\alpha'_{\textsf{DE}}\parr{\secpar} \leq 1/\secpar^2\),
    then \(\PKE\) from \cref{con:sel-to-ad} is an ad-IND-CPA/CTKL secure \(\parr{\alpha,\alpha_{\textsf{PK}},\alpha_{\textsf{DE}},\varepsilon,t}\)-tpPKE with exponential tag space where
    \begin{bralign}
        \begin{array}{rlrlrl}
            \alpha\parr{\secpar}
            &\coloneqq
            \alpha'\parr{\secpar}
            &
            \alpha_{\textsf{PK}}\parr{\secpar}
            &\coloneqq
            1 - 2/\secpar
            &
            \alpha_{\textsf{DE}}\parr{\secpar}
            &\coloneqq
            1 - 2/\secpar
            \\
            \varepsilon\parr{\secpar}
            &\leq
            1/2 + 2 \secpar \varepsilon'\parr{\secpar}
            &
            t\parr{\secpar}
            &\geq
            t'\parr{\secpar} - \poly\parr{\secpar}
        \end{array}
    \end{bralign}
    for some fixed polynomial \(\poly\).
\end{theorem}

\begin{proof}
    First, we analyze message correctness for any message \(m \in M_\secpar\) and any tag \(t \in T_\secpar\)
    \begin{bralign}
        \Pr{
            \parr{\pk,\sk} \gets \Gen\parr{1^\secpar},
            c \gets \Enc\parr{\pk,m,t}
            :
            \Dec\parr{\sk,c} \neq m
        }
        &\leq
        \Pr{\Dec\parr{\sk_1,c_1} \neq m}
        =
        \alpha'\parr{\secpar}
        \ .
    \end{bralign}
    Now, we analyze punctured key correctness for any message \(m \in M_\secpar\) and any tags \(t \neq t' \in T_\secpar\).
    Let \(\ihat\) be the first index where \(t\) and \(t'\) differ.
    We find that
    \begin{bralign}
        &\Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                c &\gets \Enc\parr{\pk,m,t}
                \\
                \sk\pars{t'} &\gets \Punct\parr{\sk,t'}
            \end{array}
            :
            \Dec\parr{\sk\pars{t'},c} \neq m
        }
        \\
        &=
        1 - \Pr{\Dec\parr{\sk\pars{t'},c} = m}
        \\
        &\leq
        1 - \Pr{\forall i < \ihat : \Dec\parr{\sk_i\pars{t'_i},c_i} = \bot \wedge \Dec\parr{\sk\pars{t'_\ihat},c_\ihat} = m}
        \\
        &=
        1 - \Pr{\Dec\parr{\sk_1\pars{t'_1},c_1} = \bot}^{\ihat-1} \cdot \Pr{\Dec\parr{\sk_\ihat\pars{t'_\ihat},c_\ihat} = m}
        \marginnote{independence of events}
        \\
        &\leq
        1 - \parr{1 - \alpha'_{\textsf{DE}}\parr{\secpar}}^{\ihat-1} \cdot \parr{1 - \alpha'_{\textsf{PK}}\parr{\secpar}}
        \\
        &\leq
        1 - \parr{1 - 1/\secpar^2}^{\ihat-1} \cdot \parr{1 - 1/\secpar^2}
        \\
        &\leq
        1 - \parr{1 - 1/\secpar^2}^\ihat
        \\
        &\leq
        1 - \parr{1 - 1/\secpar^2}^\secpar
        \\
        &\leq
        2/\secpar
        \eqqcolon
        \alpha_{\textsf{PK}}\parr{\secpar}
        \ .
    \end{bralign}
    Furthermore, we find that
    \begin{bralign}
        \Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                c &\gets \Enc\parr{\pk,m,t'}
                \\
                \sk\pars{t'} &\gets \Punct\parr{\sk,t'}
            \end{array}
            :
            \Dec\parr{\sk\pars{t'},c} \neq \bot
        }
        &=
        1 - \Pr{\Dec\parr{\sk\pars{t'},c} = \bot}
        \\
        &=
        1 - \Pr{\forall i : \Dec\parr{\sk_i\pars{t'_i},c_i} = \bot}
        \\
        &=
        1 - \Pr{\Dec\parr{\sk_1\pars{t'_1},c_1} = \bot}^\secpar
        \\
        &\leq
        1 - \parr{1 - \alpha'_{\textsf{DE}}\parr{\secpar}}^\secpar
        \\
        &\leq
        1 - \parr{1 - 1/\secpar^2}^\secpar
        \\
        &\leq
        2/\secpar
        \eqqcolon
        \alpha_{\textsf{DE}}\parr{\secpar}
        \ .
    \end{bralign}
    Now, let's prove ad-IND-CPA/CTKL security of our scheme by defining \(\secpar+1\) hybrids for each \(i \in \parc{0,...,\secpar}\)
    \begin{hybrids}
        \item[\(\H_i\)] The challenge ciphertext is generated as \(c^* = \parr{c^*_i}_{i \in \parc{1,...,\secpar}}\) with \(c^*_\iota \gets \Enc\parr{\pk'_\iota,m_\iota}\) where \(m_\iota \coloneqq m^0\) for each \(\iota > i\) and \(m_\iota \coloneqq m^1\) for each \(\iota \leq i\).
    \end{hybrids}
    Note that \(\H_0\) is the original ad-IND-CPA/CTKL with a uniformly bit \(b = 0\) and \(\H_\secpar\) with bit \(b = 1\).
    The indistinguishability of \(\H_i\) and \(\H_{i+1}\) is justified by the \(M\)-ad-IND-CPA/CTKL of \(\PKE'\).
    For each \(i \in \parc{0,\secpar-1}\) we define a reduction \(\advR_i\) from the \(M\)-ad-IND-CPA/CTKL security of \(\PKE'\) to the ad-IND-CPA/CTKL of \(\PKE\) that proceeds as follows:
    \begin{senumerate}
        \item generate \(\parr{\pk_1,\sk_1}, ..., \parr{\pk_{i-1},\sk_{i-1}}, \parr{\pk_{i+1},\sk_{i+1}}, \parr{\pk_1,\sk_1} \gets \Gen'\parr{1^\secpar}\) honestly,
        \item first guess \(\hat{t}_i \gets \bit\),
        \item submit \(\hat{t}_i\) to the \(M\)-ad-IND-CPA/CTKL challenger \(\advC\),
        \item receive \(\pk_i\) from \(\advC\) and forward \(\pk\) to the ad-IND-CPA/CTKL adversary \(\A\),
        \item receive \(\parr{m^0,m^1,t^*}\) from \(\A\),
        \item if \(\hat{t}_i \neq t^*_i\), then return a uniformly random bit \(b'' \gets \bit\) to \(\advC\),
        \item set \(m_\iota \coloneqq m^0\) for each \(\iota > i\) and \(m_\iota \coloneqq m^1\) for each \(\iota \leq i\),
        \item forward \(\parr{m^0,m^1}\) to \(\advC\),
        \item receive \(c^*_i\) and \(\sk_i\pars{\hat{t}_i}\) from \(\advC\),
        \item compose \(c^*\) with \(c^*_i\) at the \(i\)-th position and all other components \(c^*_\iota\) generated honestly as encryptions of \(m_\iota\) under \(\pk_\iota\),
        \item for each \(\iota \neq i\) puncture \(\sk_\iota\) to get \(\sk\pars{t^*_\iota}\),
        \item submit \(c^*\) and \(\sk\pars{t^*} \coloneqq \parr{\sk\pars{t^*_1}, ..., \sk\pars{t^*_{i-1}}, \sk\pars{\hat{t}_i}, \sk\pars{t^*_{i+1}}, ..., \sk\pars{t^*_\secpar}}\) to \(\advC\),
        \item receive the bit \(b'\) from \(\advC\) and forward \(b'' \coloneqq b'\) to \(\A\).
    \end{senumerate}
    Note that in case \(\advC\) chooses \(b = 0\) the reduction \(\advR\) provides a perfect view of \(\H_i\) to \(\A\) and if \(b = 1\) the reduction \(\advR\) provides a perfect view of \(\H_{i+1}\) to \(\A\).
    Let \(p_i\) be the probability that the adversary \(\A\) outputs the bit \(0\) in hybrid \(i\).
    We find that
    \begin{bralign}
        1/2 + \varepsilon'\parr{\secpar}
        &\geq
        \Pr{b'' = b}
        \\
        &=
        \Pr{b'' = b \given \hat{t}_i = t^*_i} \Pr{\hat{t}_i = t^*_i}
        +
        \Pr{b'' = b \given \hat{t}_i \neq t^*_i} \Pr{\hat{t}_i \neq t^*_i}
        \\
        &=
        \Pr{b'' = b \given \hat{t}_i = t^*_i} / 2
        +
        1/4
        \marginnote{\(\pk_i\) is independent of \(\hat{t}_i\) by definition of \(M\)-ad-IND-CPA/CTKL game, hence \(\Pr{\hat{t}_i = t^*_i} = 1/2\)}
        \\
        &=
        \Pr{b'' = 0 \given \hat{t}_i = t^*_i \wedge b = 0} / 4 - \Pr{b'' = 0 \given \hat{t}_i = t^*_i \wedge b = 1} / 4 + 1/4
        +
        1/4
        \\
        &=
        \parr{p_i - p_{i+1} + 1} / 4
        +
        1/4
        \\
        \implies
        p_i - p_{i+1}
        &\leq
        4 \varepsilon'\parr{\secpar}
        \ .
    \end{bralign}
    Using this bound we find that the adversary's success probability is bounded by
    \begin{bralign}
        \Pr{b' = b}
        &=
        \Pr{b' = 0 \given b = 0} / 2 - \Pr{b' = 0 \given b = 1} / 2 + 1/2
        \\
        &=
        p_0/2 - p_\secpar/2 + 1/2
        \\
        &=
        1/2 + \sum_{i=1}^\secpar p_i/2 - p_{i+1}/2
        \\
        &\leq
        1/2 + \sum_{i=1}^\secpar 2 \varepsilon'\parr{\secpar}
        \\
        &=
        1/2 + 2 \secpar \varepsilon'\parr{\secpar}
        \ .
    \end{bralign}
    Lastly, we note that the runtime of the the reduction is polynomial in \(\secpar\) and consists mostly of generating key pairs and encrypting \(\A\)'s messages.
    That is \(t'\parr{\secpar} \coloneqq t_\advR\parr{\secpar} + t_\A\parr{\secpar} \leq \poly\parr{\secpar} + t\parr{\secpar}\).
\end{proof}


\begin{theorem}\label{thm:M-space-expansion}
    Let \(\PKE' = \parr{\Gen',\Enc',\Dec',\Punct'}\) be an ad-IND-CPA/CCKL secure \(\parr{\alpha',\alpha'_{\textsf{PK}},\varepsilon',t'}\)-cpPKE with binary message space \(M'_\secpar \coloneq \bit\).
    Then there exists an ad-IND-CPA/CCKL \(\parr{\alpha,\alpha_{\textsf{PK}},\varepsilon,t}\)-cpPKE \(\PKE\) with exponentially large message space \(M_\secpar \coloneq \bit^\secpar\) where
    \begin{bralign}
        \begin{array}{rlrl}
            \alpha\parr{\secpar}
            &\coloneqq
            \secpar \alpha'\parr{\secpar}
            &
            \alpha_{\textsf{PK}}\parr{\secpar}
            &\coloneqq
            1 - 2/\secpar
            \\
            \varepsilon\parr{\secpar}
            &\leq
            1/2 + \secpar \varepsilon'\parr{\secpar}
            &
            t\parr{\secpar}
            &\geq
            t'\parr{\secpar} - \poly\parr{\secpar}
        \end{array}
    \end{bralign}
    for some fixed polynomial \(\poly\).
\end{theorem}

\begin{proof}
    The construction is just a bitwise encryption of the message.
    First, we define our ad-IND-CPA/CCKL PKE scheme \(\PKE\) and then prove correctness and security.
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\):
        \begin{sitemize}
            \item generate \(\parr{\pk'_1,\sk'_1}, ..., \parr{\pk'_\secpar,\sk'_\secpar} \gets \Gen'\parr{1^{\secpar}}\),
            \item set \(\pk \coloneqq \parr{\pk'_i,}_{i \in \parc{1,...,\secpar}}\) and \(\sk \coloneqq \parr{\pk,\parr{\sk'_i,}_{i \in \parc{1,...,\secpar}}}\),
            \item output \(\parr{\pk,\sk}\).
        \end{sitemize}

        \item \(\Enc\parr{\pk,m}\):
        \begin{sitemize}
            \item for each \(i \in \parc{1,...,\secpar}\) generate \(c_i \coloneqq \Enc'\parr{\pk'_i,m_i} \in \bit^{2\secpar}\),
            \item output \(c \coloneqq \parr{c_i}_{i \in \parc{1,...,\secpar}}\),
        \end{sitemize}

        \item \(\Dec\parr{\sk,c}\):
        \begin{sitemize}
            \item parse \(\parr{c_i}_{i \in \parc{1,...,\secpar}} \coloneqq c\),
            \item decrypt \(\widetilde{m}_i \coloneqq \Dec'\parr{\sk'_i,c_i}\),
            \item output \(\widetilde{m} \coloneqq \widetilde{m}_1||...||\widetilde{m}_\secpar\).
        \end{sitemize}

        \item \(\Punct\parr{\sk, c'}\):
        \begin{sitemize}
            \item parse \(\parr{c'_i}_{i \in \parc{1,...,\secpar}} \coloneqq c'\),
            \item puncture \(\sk'_i\pars{c'_i} \coloneqq \Punct'\parr{\sk'_i,c'_i}\),
            \item output \(\sk\pars{c'} \coloneqq \parr{\pk,\parr{\sk'_i\pars{c'_i}}_{i \in \parc{1,...,\secpar}}}\).
        \end{sitemize}

        \item \(\Dec\parr{\sk\pars{c'},c}\):
        \begin{sitemize}
            \item parse \(\parr{c_i}_{i \in \parc{1,...,\secpar}} \coloneqq c\),
            \item decrypt \(\widetilde{m}_i \coloneqq \Dec'\parr{\sk'_i\pars{c'_i},c_i}\),
            \item for any \(i \in \parc{1,...,\secpar}\) if \(\widetilde{m}_i = \bot\) output \(\bot\),
            \item output \(\widetilde{m} \coloneqq \widetilde{m}_1||...||\widetilde{m}_\secpar\).
        \end{sitemize}
    \end{sitemize}
    Message correctness follows directly from the perfect correctness of \(\PKE'\):
    \begin{bralign}
        \Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                c &\gets \Enc\parr{\pk,m}
            \end{array}
            :
            \Dec\parr{\sk,c} = m
        }
        &=
        \Pr{
            \forall i \in \parc{1,...,\secpar} : \Dec'\parr{\sk'_i,c_i} = m_i
        }
        \\
        &=
        1
        -
        \Pr{
            \exists i \in \parc{1,...,\secpar} : \Dec\parr{\sk'_i,c_i} \neq m_i
        }
        \\
        &\geq
        1
        -
        \sum_{i=1}^{\secpar} \Pr{\Dec'\parr{\sk'_i,c_i} \neq m_i}
        \\
        &\geq
        1 - \secpar \alpha'\parr{\secpar}
        \eqqcolon
        \alpha\parr{\secpar}
        \ .
    \end{bralign}
    Now, we prove punctured key correctness for each message \(m\) and each (possibly malformed) \(c\) ciphertext:
    \begin{bralign}
        \Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                c &\gets \Enc\parr{\pk,m}
                \\
                \sk\pars{c} &\gets \Punct\parr{\sk,c}
            \end{array}
            :
            \Dec\parr{\sk\pars{c},c} = m
        }
        &=
        \Pr{
            \forall i \in \parc{1,...,\secpar} : \Dec'\parr{\sk'_i\pars{c_i},c_i} = m_i
        }
        \\
        &=
        1
        -
        \Pr{
            \exists i \in \parc{1,...,\secpar} : \Dec'\parr{\sk'_i\pars{c_i},c_i} \neq m_i
        }
        \\
        &\geq
        1
        -
        \sum_{i=1}^{\secpar} \Pr{\Dec'\parr{\sk'_i\pars{c_i},c_i} \neq m_i}
        \\
        &\geq
        1 - \secpar \alpha'_{\textsf{PK}}\parr{\secpar}
        \eqqcolon
        \alpha_{\textsf{PK}}\parr{\secpar}
        \ .
    \end{bralign}
    Now, let's prove ad-IND-CPA/CCKL security of our scheme by defining \(\secpar+1\) hybrids for each \(i \in \parc{0,...,\secpar}\)
    \begin{hybrids}
        \item[\(\H_i\)] The challenge ciphertext is generated as \(c^* = \parr{c^*_i}_{i \in \parc{1,...,\secpar}}\) with \(c^*_\iota \gets \Enc\parr{\pk'_\iota,m_\iota}\) where \(m_\iota \coloneqq m^0\) for each \(\iota > i\) and \(m_\iota \coloneqq m^1\) for each \(\iota \leq i\).
    \end{hybrids}
    Note that \(\H_0\) is the original ad-IND-CPA/CCKL with a uniformly bit \(b = 0\) and \(\H_\secpar\) with bit \(b = 1\).
    The indistinguishability of \(\H_i\) and \(\H_{i+1}\) is justified by the ad-IND-CPA/CCKL of \(\PKE'\).
    For each \(i \in \parc{0,\secpar-1}\) we define a reduction \(\advR_i\) from the ad-IND-CPA/CCKL security of \(\PKE'\) to the ad-IND-CPA/CCKL of \(\PKE\) that proceeds as follows:
    \begin{senumerate}
        \item generate \(\parr{\pk'_1,\sk_1}, ..., \parr{\pk'_{i-1},\sk_{i-1}}, \parr{\pk'_{i+1},\sk_{i+1}}, ..., \parr{\pk'_\secpar,\sk_\secpar} \gets \Gen'\parr{1^\secpar}\) honestly,
        \item receive \(\pk'_i\) from \(\advC\) and forward \(\pk \coloneqq \parr{\pk'_i}_{i \in \parc{1,...,\secpar}}\) to the ad-IND-CPA/CTKL adversary \(\A\),
        \item submit \(\hat{t}_i\) to the \(M\)-ad-IND-CPA/CTKL challenger \(\advC\),
        \item receive \(\parr{m^0,m^1}\) from \(\A\) and forward \(\parr{m^0_i,m^1_i}\) to \(\advC\),
        \item receive \(c^*_i\) and \(\sk_i\pars{c^*_i}\) from \(\advC\),
        \item set \(m_\iota \coloneqq m^0\) for each \(\iota > i\) and \(m_\iota \coloneqq m^1\) for each \(\iota \leq i\),
        \item compose \(c^*\) with \(c^*_i\) at the \(i\)-th position and all other components \(c^*_\iota\) generated honestly as encryptions of \(m_\iota\) under \(\pk_\iota\),
        \item for each \(\iota \neq i\) puncture \(\sk_\iota\) to get \(\sk\pars{c^*_\iota}\),
        \item submit \(c^*\) and \(\sk\pars{c^*} \coloneqq \parr{\sk\pars{c^*_\iota}}_{\iota \in \parc{1,...,\secpar}}\) to \(\advC\),
        \item receive the bit \(b'\) from \(\advC\) and forward \(b'' \coloneqq b'\) to \(\A\).
    \end{senumerate}
    Note that in case \(\advC\) chooses \(b = 0\) the reduction \(\advR\) provides a perfect view of \(\H_i\) to \(\A\) and if \(b = 1\) the reduction \(\advR\) provides a perfect view of \(\H_{i+1}\) to \(\A\).
    Let \(p_i\) be the probability that the adversary \(\A\) outputs the bit \(0\) in hybrid \(i\).
    We find that
    \begin{bralign}
        1/2 + \varepsilon'\parr{\secpar}
        &\geq
        \Pr{b'' = b}
        \\
        &=
        \Pr{b'' = 0 \given b = 0} / 2 - \Pr{b'' = 0 \given b = 1} / 2 + 1/2
        +
        1/4
        \\
        &=
        \parr{p_i - p_{i+1} + 1} / 2
        \\
        \implies
        p_i - p_{i+1}
        &\leq
        2 \varepsilon'\parr{\secpar}
        \ .
    \end{bralign}
    Using this bound we find that the adversary's success probability is bounded by
    \begin{bralign}
        \Pr{b' = b}
        &=
        \Pr{b' = 0 \given b = 0} / 2 - \Pr{b' = 0 \given b = 1} / 2 + 1/2
        \\
        &=
        p_0/2 - p_\secpar/2 + 1/2
        \\
        &=
        1/2 + \sum_{i=1}^\secpar p_i/2 - p_{i+1}/2
        \\
        &\leq
        1/2 + \sum_{i=1}^\secpar \varepsilon'\parr{\secpar}
        \\
        &=
        1/2 + \secpar \varepsilon'\parr{\secpar}
        \eqqcolon
        1/2 + \varepsilon\parr{\secpar}
        \ .
    \end{bralign}
    Lastly, we note that the runtime of the the reduction is polynomial in \(\secpar\) and consists mostly of generating key pairs and encrypting \(\A\)'s messages.
    That is \(t'\parr{\secpar} \coloneqq t_\advR\parr{\secpar} + t_\A\parr{\secpar} \leq \poly\parr{\secpar} + t\parr{\secpar}\).
\end{proof}

\begin{corollary}
    The analog of \cref{thm:M-space-expansion} holds for IND-CCA/CCKL security.
\end{corollary}


\subsection{Constructions from Factoring}

\begin{construction}\label{con:HK09-KEM}
    The tpKEM scheme \(\KEM = \parr{\Gen,\Enc,\Dec,\Punct}\) that is a marginally modified version of the IND-CCA secure KEM of~\textcite{EC:HofKil09}.
    For ease of notation we split the decryption algorithm into one that takes normal secret keys and one that takes punctured secret keys.
    Let \(\BBS\) be the pseudorandom generator of~\textcite{C:BluBluShu82}.
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\):
        \begin{sitemize}
            \item sample \(P',Q' \gets \Primes_\secpar\) and set \(N \coloneqq \parr{2P'+1} \parr{2Q'+1}\),
            \item let \(\phi \coloneqq P'Q'\),
            \item sample \(\alpha \gets \pars{\parr{N-1}/4}\),
            \item sample \(g \gets \Q\R_N\),
            \item set \(X \coloneqq g^{\alpha L}\),
            \item set \(\pk \coloneqq \parr{N,g,X}\),
            \item set \(\sk \coloneqq \parr{\pk,\alpha,\phi}\),
            \item output \(\parr{\pk,\sk}\).
        \end{sitemize}
        \item \(\Enc\parr{\pk,t}\):
        \begin{sitemize}
            \item sample \(r \gets \pars{\parr{N-1}/4}\),
            \item set \(R \coloneqq g^{r L}\),
            \item set \(\tau \coloneqq g^{r 2^{\secpar/4}}\),
            \item set \(\kappa \coloneqq \BBS_N\parr{\tau}\),
            % \item set \(t \coloneqq \operatorname{\tau}\parr{R}\),
            \item set \(S \coloneqq \abs{\parr{g^t X}^r}\),
            \item output \(C \coloneqq \parr{t,R,S}\).
        \end{sitemize}
        \item \(\Dec\parr{\sk,C}\):
        \begin{sitemize}
            \item parse \(\parr{t,R,S} \coloneqq C\),
            \item set \(a,b,c\) such that \(\gcd\parr{t,L} = 2^c = a t + b L\),
            \item set \(\tau \coloneqq \parr{S^{2a} R^{2b-2a\alpha}}^{2^{\secpar/4-c-1}}\),
            \item output \(\kappa \coloneqq \BBS_N\parr{\tau}\).
        \end{sitemize}

        \item \(\Punct\parr{\sk,t'}\):
        \begin{sitemize}
            \item set \(\beta \coloneqq \alpha + t'/L \mod \phi\),
            \item output \(\sk\pars{t'} \coloneqq \parr{\pk,\beta,t'}\).
        \end{sitemize}
        \item \(\Dec\parr{\sk[t'],C}\):
        \begin{sitemize}
            \item parse \(\parr{t,R,S} \coloneqq C\),
            \item if \(t = t'\) output \(\bot\),
            \item set \(a',b',c'\) such that \(\gcd\parr{t-t',L} = 2^{c'} = a' \parr{t-t'} + b' L\),
            \item set \(\tau' \coloneqq \parr{S^{2a'} R^{2b'-2a'\beta}}^{2^{\secpar/4-c'-1}}\),
            \item output \(\kappa \coloneqq \BBS_N\parr{\tau'}\).
        \end{sitemize}
    \end{sitemize}
\end{construction}

\begin{theorem}[Informal]
    If the factoring assumption holds,
    then there exists a sel-IND-CPA/CTKL secure tpKEM.
\end{theorem}

\begin{theorem}\label{thm:HK09-KEM}
    If the \(\parr{t_{\textsf{IF}},\varepsilon_{\textsf{IF}}}\)-factoring assumption holds,
    then \cref{con:HK09-KEM} is a sel-IND-CPA/CTKL secure \(\parr{\alpha,\alpha_{\textsf{PK}},t,\varepsilon}\)-tpKEM with tag space \(K_\secpar \coloneqq \bit^{\secpar/4}\),
    tag space \(T_\secpar \coloneqq \pars{2^{\secpar/4}}\) where
    \begin{bralign}
        \alpha\parr{\secpar}
        &\coloneqq
        \alpha_{\textsf{PK}}\parr{\secpar}
        \coloneqq
        2^{-\lambda+2}
        \\
        \varepsilon\parr{\secpar} &\coloneqq \varepsilon_{\textsf{IF}}\parr{\secpar} \cdot \secpar/4 + 2^{-\secpar+5}
        \\
        t\parr{\secpar} &\geq t_{\textsf{IF}}\parr{\secpar} / 16 \secpar^4 \cdot \varepsilon_{\textsf{IF}}\parr{\secpar}^2
    \end{bralign}
    \marginnote{Upper bound on \(\ell_K\)?}
\end{theorem}

\begin{proof}
    Let \(L \coloneqq 2^{\secpar/2}\).
    Statistical decapsulation correctness follows directly from the statistical correctness of the original KEM of~\cite{EC:HofKil09}.
    Note here that whether the tag \(t\) is chosen arbitrarily or is the evaluation of a hash function (as in the original KEM) does not affect correctness.
    Now, we prove punctured key correctness for each message \(m\) and each (possibly malformed) \(c\) ciphertext.
    We declare an event \(\textsf{GOOD}\) which we define and analyze later.
    For now, we only need to know that conditioned on \(\textsf{GOOD}\) the element \(g\) is a generator of \(\Q\R_N\).
    We see that
    \begin{bralign}
        &\Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                c &\gets \Enc\parr{\pk,t}
                \\
                \sk\pars{t'} &\gets \Punct\parr{\sk,t'}
            \end{array}
            :
            \Dec\parr{\sk\pars{t'},c} \neq \Dec\parr{\sk,c}
        }
        \\
        &=
        \Pr{\Dec\parr{\sk\pars{t'},c} \neq \Dec\parr{\sk,c} \wedge \bracket{g} = \Q\R_N}
        +
        \Pr{\Dec\parr{\sk\pars{t'},c} \neq \Dec\parr{\sk,c} \wedge \bracket{g} \neq \Q\R_N}
        \\
        &=
        \Pr{\Dec\parr{\sk\pars{t'},c} \neq \Dec\parr{\sk,c} \wedge \bracket{g} = \Q\R_N}
        +
        \Pr{\bracket{g} \neq \Q\R_N}
        \\
        &\leq
        \Pr{\Dec\parr{\sk\pars{t'},c} \neq \Dec\parr{\sk,c} \given \bracket{g} = \Q\R_N}
        +
        \parr{P + Q - 1}/PQ
        \\
        &\leq
        \Pr{\Dec\parr{\sk\pars{t'},c} \neq \Dec\parr{\sk,c} \given \bracket{g} = \Q\R_N}
        +
        2^{-\lambda+2}
        \\
        &=
        \Pr{\tau' \neq \tau \given
            \begin{array}{rl}
                \bracket{g} &= \Q\R_N
                \\
                \gcd\parr{t,L} &= 2^c = a t + b L
                \\
                \tau &\coloneqq \parr{S^{2a} R^{2b-2a\alpha}}^{2^{\secpar/4-c-1}}
                \\
                \gcd\parr{t-t',L} &= 2^{c'} = a' \parr{t-t'} + b' L
                \\
                \tau' &\coloneqq \parr{S^{2a'} R^{2b'-2a'\beta}}^{2^{\secpar/4-c'-1}}
            \end{array}
        }
        +
        2^{-\lambda+2}
        \\
        &=
        \Pr{
            \begin{array}{c}
                \parr{{a'rt+a'\beta rL-a'rt'} + {b'rL-a'\beta rL}} / 2^{c'}
                \\
                \neq
                \parr{{art+a\alpha rL} + {brL-a\alpha rL}} / 2^c
            \end{array}
            \given
            \begin{array}{rl}
                \bracket{g} &= \Q\R_N
                \\
                \gcd\parr{t,L} &= 2^c = a t + b L
                \\
                \gcd\parr{t-t',L} &= 2^{c'} = a' \parr{t-t'} + b' L
            \end{array}
        }
        +
        2^{-\lambda+2}
        \\
        &=
        \Pr{
            \parr{a'rt-a'rt' + b'rL} / 2^{c'} \neq \parr{art + brL} / 2^c
            \given
            \begin{array}{rl}
                \bracket{g} &= \Q\R_N
                \\
                \gcd\parr{t,L} &= 2^c = a t + b L
                \\
                \gcd\parr{t-t',L} &= 2^{c'} = a' \parr{t-t'} + b' L
            \end{array}
        }
        +
        2^{-\lambda+2}
        \\
        &=
        \Pr{
            r \neq r
            \given
            \begin{array}{rl}
                \bracket{g} &= \Q\R_N
                \\
                \gcd\parr{t,L} &= 2^c = a t + b L
                \\
                \gcd\parr{t-t',L} &= 2^{c'} = a' \parr{t-t'} + b' L
            \end{array}
        }
        +
        2^{-\lambda+2}
        \\
        &=
        2^{-\lambda+2}
    \end{bralign}
    Now, let's prove sel-IND-CPA/CTKL security of our scheme.
    \begin{hybrids}
        \item This is the original sel-IND-CPA/CTKL with bit \(b = 0\), i.e., the challenge key \(\kappa = \kappa^*\) is the actual key.
        In particular, the challenge ciphertext is \(c^* = \parr{t^*,R^*,S^*}\).

        \item We sample \(\beta \gets \pars{\parr{N-1}/4}\).
        The public key is set as \(X \coloneqq g^{\beta L - t'}\) instead of sampling \(\alpha \gets \pars{\parr{N-1}/4}\) and setting \(X \coloneqq g^{\alpha L}\).
        Note that here we do not need the secret \(\phi\) anymore.
        The distribution of \(\parr{N,g,X,C^*}\) is equal in this and the previous hybrid conditioned on \(\textsf{GOOD}\).

        \item We set \(b = 1\), i.e., the challenge key \(\kappa \gets \bit^\secpar\) is a random key.
    \end{hybrids}
    We define the event \(\textsf{GOOD}\) as \(\bracket{g} = \Q\R_N\) and \(\alpha,\beta,r^* \leq \card{\Q\R_N} = P \cdot Q\).
    We find that \(\textsf{GOOD}\) occurs with overwhelming probability
    \begin{bralign}
        \Pr{\textsf{GOOD}}
        &\geq
        1 - \Pr{\bracket{g} \neq \Q\R_N} - \Pr{\alpha > P \cdot Q} - \Pr{\beta > P \cdot Q} - \Pr{r^* > P \cdot Q}
        \\
        &=
        1 - \Pr{\bracket{g} \neq \Q\R_N} - 3\Pr{\alpha > P \cdot Q}
        \\
        &=
        1 - \parr{P + Q - 1}/PQ - 3 \cdot 2 \parr{P + Q} / \parr{N - 1}
        \\
        &\geq
        1 - 2^{-\secpar+5}
        \ .
    \end{bralign}
    Let \(p_i\) be the probability that the adversary \(\A\) outputs the correct bit in hybrid \(i\).
    Similarly, let \(p'_i\) be the adversary's success probability conditioned on \(\textsf{GOOD}\).
    Because \(p_1 \coloneqq 1/2 + \varepsilon\parr{\secpar}\) is the adversary's advantage in the original sel-IND-CPA/CTKL security game and \(p_3 = p'_3 = 1/2\),
    we see
    \begin{bralign}
        \varepsilon\parr{\secpar}
        =
        p_1 - 1/2
        &\leq
        p'_1 + \Pr{\overline{\textsf{GOOD}}} - 1/2
        \\
        &\leq
        \abs{p'_1 - p'_2} + \abs{p'_2 - p'_3} + p'_3 + \Pr{\overline{\textsf{GOOD}}} - 1/2
        \\
        &\leq
        2^{-\secpar+5} + \varepsilon_{\textsf{BBS}}\parr{\secpar}
        \\
        &\leq
        2^{-\secpar+5} + \varepsilon_{\textsf{IF}}\parr{\secpar} \cdot \secpar/4
    \end{bralign}
    Lastly, we can analyze the runtime of the factoring algorithm that result from the assumed sel-IND-CPA/CTKL distinguisher.
    We see
    \begin{bralign}
        t_{\textsf{BSS}}\parr{\secpar}
        &\leq
        \secpar^2 t\parr{\secpar}
        \\
        \implies
        t_{\textsf{IF}}\parr{\secpar}
        &\leq
        \secpar^4 t_{\textsf{BBS}}\parr{\secpar}/\varepsilon_{\textsf{BBS}}\parr{\secpar}^2
        \\
        &\leq
        \secpar^6 t\parr{\secpar} / \varepsilon_{\textsf{BBS}}\parr{\secpar}^2
        \\
        &\leq
        16 \secpar^4 t\parr{\secpar} / \varepsilon_{\textsf{IF}}\parr{\secpar}^2
    \end{bralign}
\end{proof}

\begin{remark}
    Note that \cref{con:HK09-KEM} does not fulfill the IND-CCA/CTKL notion because the reduction \(\advR\) cannot decrypt ciphertexts with the challenge tag \(t^*\).
\end{remark}

\begin{lemma}[BBS pseudorandom generator]
    If the \(\parr{t_{\textsf{IF}},\varepsilon_{\textsf{IF}}}\)-factoring assumption holds,
    the \(\ell_{\textsf{K}}\)-BBS pseudorandom generator is \(\parr{t_{\textsf{BBS}},\varepsilon_{\textsf{BBS}}}\)-indistinguishable where
    \begin{bralign}
        t_{\textsf{IF}}\parr{\secpar}
        \leq
        \secpar^4 t_{\textsf{BBS}}\parr{\secpar}/\varepsilon_{\textsf{BBS}}\parr{\secpar}^2
        \hspace*{2cm}
        \varepsilon_{\textsf{IF}}\parr{\secpar}
        \geq
        \varepsilon_{\textsf{BBS}}\parr{\secpar}/\ell_{\textsf{K}}\parr{\secpar}
        \ .
    \end{bralign}
\end{lemma}


\subsection{Constructions from iO}

\begin{theorem}[Informal]
    Let \(\PKE' = \parr{\Gen',\Enc',\Dec'}\) be a IND-CPA secure PKE.
    Let \(\iO\) be an indistinguishability obfuscator.
    Let \(\NIWI = \parr{\Prove,\Verify}\) be a perfectly sound NIWI.
    Let \(\COM = \parr{\Setup,\Commit,\Open}\) be a perfectly binding commitment scheme.
    Then there exists an ad-IND-CPA/CCKL cpPKE \(\PKE\) with binary message space \(M_\secpar \coloneq \parc{0^\secpar,1^\secpar}\).
\end{theorem}

\begin{theorem}
    Let \(\PKE' = \parr{\Gen',\Enc',\Dec'}\) be a perfectly correct \(\varepsilon_{\PKE'}\)-IND-CPA secure PKE.
    Let \(\iO\) be an \(\varepsilon_{\iO}\)-indistinguishable obfuscator.
    Let \(\NIWI = \parr{\Prove,\Verify}\) be a \(\varepsilon_{\NIWI}\)-indistinguishable perfectly sound NIWI.
    Let \(\COM = \parr{\Setup,\Commit,\Open}\) be a \(\varepsilon_{\textsf{hide}}\)-hiding perfectly binding commitment scheme.
    Then there exists an \(\varepsilon_{\PKE}\)-ad-IND-CPA/CCKL cpPKE \(\PKE\) with binary message space \(M_\secpar \coloneq \parc{0^\secpar,1^\secpar}\) where \(\varepsilon_{\PKE}\parr{\secpar} \leq 2\varepsilon_{\textsf{hide}}\parr{\secpar} + \varepsilon_{\NIWI}\parr{\secpar} + \varepsilon_{\iO}\parr{\secpar} + 2\varepsilon_{\PKE'}\parr{\secpar}\).
\end{theorem}

\begin{proof}
    W.l.o.g.\ we assume \(m^b \coloneqq b^\secpar\).
    \marginnote{Otherwise we redefine the adversary to flip its output.}
    For simple exhibition we assume that the underlying PKE and obfuscator are perfectly correct and the commitment scheme is perfectly binding.
    For statistical security we would have to add the negligible probability that the generation algorithms \(\Gen'\) and \(\Setup\) output \enquote{faulty} parameters.
    First, we define our ad-IND-CPA/CCKL PKE scheme and then prove correctness and security.
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\):
        \begin{sitemize}
            \item sample \(R \gets \bit^{4\secpar+1}\),
            \item generate \(\pp \gets \Setup\parr{1^{\secpar}}\),
            \item generate \(\parr{\pk'_1,\sk'_1}, \parr{\pk'_2,\sk'_2} \gets \Gen'\parr{1^{\secpar}}\),
            \item generate \(C \coloneqq \Commit\parr{\pp,0^{4\secpar+1};R}\),
            \item set \(\pk \coloneqq \parr{\pp,\pk'_1,\pk'_2,C}\) and \(\sk \coloneqq \parr{\pk,\sk'_1}\),
            \item output \(\parr{\pk,\sk}\).
        \end{sitemize}

        \item \(\Enc\parr{\pk,m}\):
        \begin{sitemize}
            \item sample \(r_1,r_2 \gets \bit^\secpar\),
            \item set \(c_1 \coloneqq \Enc'\parr{\pk'_1,m;r_1} \in \bit^{2\secpar}\),
            \item set \(c_2 \coloneqq \Enc'\parr{\pk'_2,m;r_2} \in \bit^{2\secpar}\),
            \item prove \(\pi \gets \Prove\parr{s_{\pk,c_1,c_2},m,r_1,r_2}\) where \(s_{\pk,c_1,c_2}\) is following statement
            \begin{bralign}\label{eq:consistency}
                &\ \parr{
                    \exists m,r_1,r_2 :
                    c_1 = \Enc\parr{\pk'_1,m;r_1}
                    \wedge
                    c_2 = \Enc\parr{\pk'_2,m;r_2}
                }
                \\\label{eq:trapdoor}
                \vee
                &\ \parr{
                    \exists R :
                    C = \Commit\parr{\pp,c_1||c_2||1;R}
                }
                \ ,
            \end{bralign}
            \item output \(c \coloneqq \parr{c_1,c_2,\pi}\),
        \end{sitemize}
        Note that with an honestly generated public key \cref{eq:trapdoor} cannot be fulfilled.

        \item \(\Dec\parr{\sk,c}\):
        \begin{sitemize}
            \item parse \(\parr{c_1,c_2,\pi} \coloneqq c\),
            \item if \(\Verify\parr{s_{\pk,c_1,c_2},\pi} = 0\) output \(\bot\),
            \item output \(\widetilde{m} \coloneqq \Dec'\parr{\sk'_1,c_1}\).
        \end{sitemize}

        \item \(\Punct\parr{\sk, c'}\):
        \begin{sitemize}
            \item parse \(\parr{c'_1,c'_2,\pi'} \coloneqq c'\),
            \item if \(\Verify\parr{s_{\pk,c'_1,c'_2},\pi'} = 0\), return \(\sk\),
            \item output \(\sk\pars{c'} \gets \iO\parr{C_{\sk,c'}}\) where \(C_{\sk,c'}\) is the circuit that on input \(c = \parr{c_1,c_2,\pi}\)
            \begin{sitemize}
                \item if \(\Verify\parr{s_{\pk,c_1,c_2},\pi} = 0\) or \(c_1||c_2 = c'_1||c'_2\), outputs \(\bot\),
                \item outputs \(\widetilde{m} \coloneqq \Dec'\parr{\sk'_1,c_1}\).
            \end{sitemize}
        \end{sitemize}

        \item \(\Dec\parr{\sk\pars{t'},c}\):
        \begin{sitemize}
            \item output \(\sk\pars{t'}\parr{c}\).
        \end{sitemize}
    \end{sitemize}
    Perfect message correctness follows directly from the perfect correctness of \(\PKE'\), \(\NIWI\) and \(\COM\).
    Now, we prove punctured key correctness for each message \(m\) and each (possibly malformed) \(c\) ciphertext.
    Note that if \(c\) is malformed, i.e, verification fails, then \(\sk\pars{c'} = \sk\) and punctured key correctness follows directly from normal message correctness.
    Hence, we consider only wellformed ciphertexts \(c\), i.e., there exists \(m',r'_1,r'_2\) such that \(c'_1 = \Enc\parr{\pk,m';r'_1} \wedge c'_2 = \Enc\parr{\pk,m';r'_2}\).
    We see that
    \begin{bralign}
        &\Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                c &\gets \Enc\parr{\pk,m}
                \\
                \sk\pars{c'} &\gets \Punct\parr{\sk,c'}
            \end{array}
            :
            \Dec\parr{\sk\pars{c'},c} \neq m
        }
        \\
        &=
        \Pr{c_1||c_2 = c'_1||c'_2}
        \\
        &=
        \Pr{c_1||c_2 = c'_1||c'_2 \wedge m = m'}
        +
        \Pr{c_1||c_2 = c'_1||c'_2 \wedge m \neq m'}
        \marginnote{Perfect correctness of \(\PKE'\)}
        \\
        &=
        \Pr{c_1||c_2 = c'_1||c'_2 \wedge m = m'}
        \\
        &\leq
        \Pr{r_1||r_2 = r'_1||r'_2}
        \\
        &=
        2^{-2\secpar}
    \end{bralign}
    Now, let's prove ad-IND-CPA/CCKL security of our scheme.
    \begin{hybrids}
        \item This is the original ad-IND-CPA/CCKL with a uniformly random bit \(b \gets \bit\).
        In particular, the challenge ciphertext is \(c^* = \parr{c^*_1,c^*_2,\pi^*}\).

        \item We set \(C \coloneqq \Commit\parr{\pp,c^*_1||c^*_2||1;R}\).
        This step is justified by the (computational) hiding property of the commitment scheme because the randomness \(R\) is only used to generate \(C\).

        \item We prove \(\pi^* \gets \Prove\parr{s_{\pk,,c^*_1,c^*_2},w}\) using as witness \(w \coloneqq R\) instead of \(\parr{m^b,r^*_1,r^*_2}\).
        Note that now \cref{eq:trapdoor} is fulfilled instead of \cref{eq:consistency}.
        This step is justified by the (computational) witness indistinguishability of the NIWI.

        \item We set \(c^*_2 \gets \Enc\parr{\pk'_2,0^{\secpar-1}||1;r^*_2}\) instead of \(\Enc\parr{\pk'_2,m^b;r^*_2}\).
        This step is justified by the (computational) IND-CPA security of the underlying PKE \(\PKE'\) because neither the secret key \(\sk'_2\) nor the randomness \(r^*_2\) are used (except to generate \(c^*_2\)).

        \item We set \(\sk\pars{t^*} \gets \iO\parr{C'_{\sk_2,c^*_1,c^*_2}}\) where \(C'_{\sk_2,c^*_1,c^*_2}\) does the following on input a ciphertext \(c\):
        \begin{sitemize}
            \item parse \(\parr{c_1,c_2,\pi} \coloneqq c\),
            \item if \(\Verify\parr{s_{\pk,c_1,c_2},\pi} = 0\) or \(c_1||c_2 = c^*_1||c^*_2\), output \(\bot\),
            \item output \(\widetilde{m} \coloneqq \Dec'\parr{\sk'_2,c_2}\).
        \end{sitemize}
        Now, \(\sk\pars{t^*}\) contains \(\sk'_2\) but \(\sk'_1\) is no longer used.
        This step is justified by the indistinguishability of \(\iO\) and the functional equivalence of \(C_{\sk_1,k'}\) and \(C'_{\sk_2,c^*_1,c^*_2}\).
        Let us argue in detail why the two circuit are equivalent.
        First, if the verification fails \(\Verify\parr{s_{\pk,c^*_1,c^*_2} = 0}\),
        then both circuits output \(\bot\).
        Thus we can concentrate on inputs (ciphertexts) where the verification passes \(\Verify\parr{s_{\pk,c^*_1,c^*_2}} = 1\).
        Because of the perfect soundness of the NIWI that either \cref{eq:consistency} or \cref{eq:trapdoor} holds but not both because \(c^*_2\) contains \(0^{\secpar-1}||1\) while \(c^*_1\) contains \(m^b = b^\secpar\).
        \begin{sitemize}
            \item If \cref{eq:consistency} holds,
            then (by perfect correctness of \(\PKE'\)) \(c_1\) and \(c_2\) contain the same plaintext \(\widetilde{m}\) and (by negation of \cref{eq:trapdoor}) \(c_1||c_2 \neq c^*_1||c^*_2\).
            Thus, if both circuits output the same value \(\widetilde{m} \neq \bot\) because the abort conditions \(c_1||c_2 \neq c^*_1||c^*_2\) and failed verification are not fulfilled.

            \item If \cref{eq:trapdoor} holds, then \(c_1||c_2 = c^*_1||c^*_2\) because the perfectly binding commitment \(C\) contains \(c^*_1||c^*_2||1\).
            In this case the both \(\bot\) because of the abort condition \(c_1||c_2 = c^*_1||c^*_2\).
        \end{sitemize}

        \item We set \(c^*_1 \gets \Enc\parr{\pk'_1,0^{\secpar};r^*_1}\) instead of \(\Enc\parr{\pk'_1,m^b||k^*;r^*_1}\).
        Note that this hybrid is independent of the bit \(b\).
        This step is justified by the (computational) IND-CPA security of the underlying PKE \(\PKE'\) because neither the secret key \(\sk'_1\) nor the randomness \(r^*_1\) are used (except to generate \(c^*_1\)).
    \end{hybrids}
    Let
    \begin{bralign}
        p_i \coloneqq
        \Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                \parr{m^0,m^1} &\gets \A_1\parr{\pk}
                \\
                b &\gets \bit
                \\
                \parr{\sk\pars{c^*},c^*} &\gets \H_i\parr{\pk,\sk,m^0,m^1}
                \\
                b' &\gets \A_2\parr{\pk,c^*,\sk\pars{t^*}}
            \end{array}
            :
            b' = b
        }
    \end{bralign}
    be the probability that the adversary \(\A\) outputs the correct bit in hybrid \(i\).
    Because \(p_1\) is the adversary's advantage in the original ad-IND-CPA/CCKL security game and \(p_6 = 1/2\),
    we see
    \begin{bralign}
        p_1
        &\leq
        \abs{p_1 - p_2} + \abs{p_2 - p_3} + \abs{p_3 - p_4} + \abs{p_4 - p_5} + \abs{p_5 - p_6} + p_6
        \\
        &\leq
        \varepsilon_{\textsf{hide}}\parr{\secpar} + \varepsilon_{\textsf{WI}}\parr{\secpar} + \varepsilon_{\textsf{IND-CPA}}\parr{\secpar} + \varepsilon_{\textsf{iO}}\parr{\secpar} + \varepsilon_{\textsf{IND-CPA}}\parr{\secpar} + 1/2
        \\
        &\leq
        1/2 + \negl\parr{\secpar}
    \end{bralign}

    Note that our scheme only uses obfuscation for the punctured secret key.
\end{proof}


\begin{theorem}[Informal]
    Let \(\PKE' = \parr{\Gen',\Enc',\Dec'}\) be a perfectly correct IND-CPA secure PKE.
    Let \(\CH' = \parr{\Gen',\Eval',\Coll'}\) be a perfectly correct obliviously samplable Chameleon hash function.
    Let \(\pcdiO\) be an public-coin differing-input obfuscator.
    Let \(\NIWI = \parr{\Prove,\Verify}\) be a perfectly sound NIWI.
    Let \(\COM = \parr{\Setup,\Commit,\Open}\) be a perfectly binding commitment scheme.
    Then there exists an ad-IND-CPA/CTKL cpPKE \(\PKE\) with perfect punctured key correctness.
\end{theorem}

\begin{theorem}\label{thm:construction-of-perfect-PK-correctness}
    Let \(\CH' = \parr{\Gen',\Eval',\Coll'}\) be a perfectly correct obliviously samplable Chameleon hash function.
    Let \(\pcdiO\) be an \(\varepsilon_{\textsf{iO}}\)-indistinguishable public-coin differing-input obfuscator.
    Let \(\NIWI = \parr{\Setup_{\textsf{hiding}},\Setup_{\textsf{binding}},\Prove,\Verify}\) be a \(\varepsilon_{\textsf{WI}}\)-indistinguishable (perfectly) dual-mode NIWI.
    Let \(\COM = \parr{\Setup,\Commit,\Open}\) be a \(\varepsilon_{\textsf{hide}}\)-hiding perfectly binding commitment scheme.
    Then there exists an \(\parr{0,0,\varepsilon}\)-ad-IND-CPA/CTKL tpPKE \(\PKE\) with binary message space \(M_\secpar \coloneq \parc{0^\secpar,1^\secpar}\) where \(\varepsilon\parr{\secpar} \leq ...\).
\end{theorem}

\begin{proof}
    W.l.o.g.\ we assume \(m^b \coloneqq b^\secpar\).
    \marginnote{Otherwise we redefine the adversary to flip its output.}
    For simple exhibition we assume that the underlying PKE and obfuscator are perfectly correct and the commitment scheme is perfectly binding.
    For statistical security we would have to add the negligible probability that the generation algorithms \(\Gen'\) and \(\Setup\) output \enquote{faulty} parameters.
    First, we define our ad-IND-CPA/CTKL PKE scheme and then prove correctness and security.
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\):
        \begin{sitemize}
            \item sample \(R \gets \bit^{7\secpar+1}\),
            \item generate \(\pp \gets \Setup\parr{1^{\secpar}}\),
            \item generate \(\CRS \gets \Setup_{\textsf{binding}}\),
            \item generate \(\parr{\pk'_1,\sk'_1}, \parr{\pk'_2,\sk'_2} \gets \Gen'\parr{1^{\secpar}}\),
            \item generate \(C \coloneqq \Commit\parr{\pp,0^{7\secpar+1};R}\),
            \item set \(\pk \coloneqq \parr{\pp,\CRS,\pk'_1,\pk'_2,C}\) and \(\sk \coloneqq \parr{\pk,\sk'_1}\),
            \item output \(\parr{\pk,\sk}\).
        \end{sitemize}

        \item \(\Enc\parr{\pk,m,t}\):
        \begin{sitemize}
            \item sample \(r_1,r_2,r_h,r_\COM \gets \bit^\secpar\),
            \item set \(c_1 \coloneqq \Enc'\parr{\pk'_1,m;r_1} \in \bit^{2\secpar}\),
            \item set \(c_2 \coloneqq \Enc'\parr{\pk'_2,m;r_2} \in \bit^{2\secpar}\),
            \item set \(c_h \coloneqq \Commit\parr{\pp,r_h;r_\COM} \in \bit^{2\secpar}\),
            \item set \(y \coloneqq h\parr{t||c_1||c_2,r_h}\),
            \item prove \(\pi \gets \Prove\parr{s_{\pk,c_1,c_2,c_h,y},m,r_1,r_2,r_h,r_\COM}\) where \(s_{\pk,c_1,c_2}\) is following statement
            \begin{bralign}\label{eq:consistency2}
                &\ \parr{\begin{array}{c}
                    \exists m,r_1,r_2 :
                    c_1 = \Enc\parr{\pk'_1,m;r_1}
                    \wedge
                    c_2 = \Enc\parr{\pk'_2,m;r_2}
                    \ \wedge
                    \\
                    \exists r_h,r_\COM :
                    h\parr{t||c_1||c_2,r_h} = y
                    \wedge
                    c_h = \Commit\parr{\pp,r_h;r_\COM}
                \end{array}}
                \\\label{eq:trapdoor2}
                \vee
                &\ \parr{
                    \exists R :
                    C = \Commit\parr{\pp,c_1||c_2||y||1;R}
                }
                \ ,
            \end{bralign}
            \item output \(c \coloneqq \parr{c_1,c_2,c_h,y,\pi}\),
        \end{sitemize}
        Note that with an honestly generated public key \cref{eq:trapdoor2} cannot be fulfilled.

        \item \(\Dec\parr{\sk,c}\):
        \begin{sitemize}
            \item parse \(\parr{c_1,c_2,c_h,y,\pi} \coloneqq c\),
            \item if \(\Verify\parr{s_{\pk,c_1,c_2,c_h,y},\pi} = 0\) output \(\bot\),
            \item output \(\widetilde{m} \coloneqq \Dec'\parr{\sk'_1,c_1}\).
        \end{sitemize}

        \item \(\Punct\parr{\sk,t'}\):
        \begin{sitemize}
            \item output \(\sk\pars{t'} \gets \pcdiO\parr{C_{\sk,t'}}\) where \(C_{\sk,t'}\) is the circuit that on input \(c = \parr{t,c_1,c_2,c_h,y,\pi}\)
            \begin{sitemize}
                \item if \(\Verify\parr{s_{\pk,c_1,c_2,c_h,y},\pi} = 0\) or \(t=t'\), outputs \(\bot\),
                \item outputs \(\widetilde{m} \coloneqq \Dec'\parr{\sk'_1,c_1}\).
            \end{sitemize}
        \end{sitemize}

        \item \(\Dec\parr{\sk\pars{t'},c}\):
        \begin{sitemize}
            \item output \(\sk\pars{t'}\parr{c}\).
        \end{sitemize}
    \end{sitemize}
    Perfect message correctness follows directly from the perfect correctness of \(\PKE'\) and \(\NIWI\).
    Similarly, perfect punctured key correctness follows from the perfect correctness of \(\PKE'\), \(\NIWI\) and \(\pcdiO\).
    Now, let's prove ad-IND-CPA/CCKL security of our scheme.
    \begin{hybrids}
        \item This is the original ad-IND-CPA/CTKL with a uniformly random bit \(b \gets \bit\).
        In particular, the challenge ciphertext is \(c^* = \parr{c^*_1,c^*_2,c^*_h,y^*,\pi^*}\).
        Additionally, let \(\hat{r}^*_h \coloneqq \Coll\parr{\tau,t^*||c^*_1||c^*_2,r^*_h,0^{5\secpar}}\) be a (yet) unused value such that \(y^* = h\parr{0^{5\secpar},\hat{r}^*_h}\).

        \item We set \(\CRS \coloneqq \Setup_{\textsf{hiding}}\parr{1^\secpar}\).
        This step is justified by the (computational) CRS indistinguishability of the dual-mode NIWI.

        \item We set \(C \coloneqq \Commit\parr{\pp,c^*_1||c^*_2||c^*_h||y^*||1;R}\).
        This step is justified by the (computational) hiding property of the commitment scheme because the randomness \(R\) is only used to generate \(C\).

        \item We prove \(\pi^* \gets \Prove\parr{s_{\pk,c^*_1,c^*_2,c^*_h,y^*},w}\) using as witness \(w \coloneqq R\) instead of \(\parr{m^b,r^*_1,r^*_2,r^*_h,r^*_\COM}\).
        Note that now \cref{eq:trapdoor2} is fulfilled instead of \cref{eq:consistency2}.
        This step is justified by the (computational) witness indistinguishability of the NIWI.
        \marginnote{randomness \(r^*_2\) and \(r^*_\COM\) is no longer used}

        \item We sample \(\hat{r}^*_h \gets \bit^{5\secpar}\) and set \(y^* \coloneqq h\parr{0^{5\secpar},\hat{r}^*_h}\).
        This step is justified by the (computational) well-distributedness property of the Chameleon hash function because the trapdoor \(\tau\) is not used anywhere else.

        \item We set \(c^*_2 \gets \Enc\parr{\pk'_2,0^{\secpar-1}||1;r^*_2}\) instead of \(\Enc\parr{\pk'_2,m^b;r^*_2}\).
        This step is justified by the (computational) IND-CPA security of the underlying PKE \(\PKE'\) because neither the secret key \(\sk'_2\) nor the randomness \(r^*_2\) are used (except to generate \(c^*_2\)).

        \item We set \(c^*_h \coloneqq \Commit\parr{\pp,0^\secpar;r^*_\COM}\).
        This step is justified by the (computational) hiding property of the commitment scheme because the randomness \(r^*_\COM\) is only used to generate \(c^*_h\).
        \marginnote{\(r^*_h\) is no long used \(\implies\) \(\tau\) is no longer used}

        \item We set \(\CRS \coloneqq \Setup_{\textsf{binding}}\parr{1^\secpar}\).
        This step is justified by the (computational) CRS indistinguishability of the dual-mode NIWI.

        \item We set \(\sk\pars{t^*} \gets \pcdiO\parr{C_{\sk_2}}\) where \(C_{\sk_2}\) does the following on input a ciphertext \(c\):
        \begin{sitemize}
            \item parse \(\parr{c_1,c_2,c_h,y\pi} \coloneqq c\),
            \item if \(\Verify\parr{s_{\pk,c_1,c_2,c_h,y},\pi} = 0\) or \(t=t'\), output \(\bot\),
            \item output \(\widetilde{m} \coloneqq \Dec'\parr{\sk'_2,c_2}\).
        \end{sitemize}
        Now, \(\sk\pars{t^*}\) contains \(\sk'_2\) but \(\sk'_1\) is no longer used.
        This step is justified by the indistinguishability of \(\pcdiO\) and the computational equivalence of \(C_{\sk_1}\) and \(C'_{\sk_2}\).
        Let us argue in detail why it is hard to find differing inputs for the two circuit.
        First, if the verification fails \(\Verify\parr{s_{\pk,c_1,c_2,c_h,y} = 0}\),
        then both circuits output \(\bot\).
        Thus we can concentrate on inputs (ciphertexts) where the verification passes \(\Verify\parr{s_{\pk,c^*_1,c^*_2,c^*_h,y^*} = 1}\).
        Because of the perfect soundness of the NIWI that either \cref{eq:consistency2} or \cref{eq:trapdoor2} holds but not both because \(c^*_2\) contains \(0^{\secpar-1}||1\) while \(c^*_1\) contains \(m^b = b^\secpar\).
        If \cref{eq:consistency2} holds,
        then (by perfect correctness of \(\PKE'\)) \(c_1\) and \(c_2\) contain the same plaintext \(\widetilde{m}\) and hence both circuits the same value.
        \\
        Consequently, the two circuits only differ on inputs \(c = \parr{t,c_1,c_2,c_h,y,\pi}\) where \(\pi\) verifies but \(c_1\) and \(c_2\) contain inconsistent messages.
        By the perfect soundness of the NIWI (in the binding mode) \cref{eq:trapdoor2} must hold and using the extraction trapdoor \(\tau_\NIWI\) we can extract the witness \(w = R\) from such a proof \(\pi\).
        However, the easiness of finding such a commitment randomness \(R\) contradicts the hiding property of the commitment scheme.

        \item We set \(c^*_1 \gets \Enc\parr{\pk'_1,0^{\secpar};r^*_1}\) instead of \(\Enc\parr{\pk'_1,m^b||k^*;r^*_1}\).
        Note that this hybrid is independent of the bit \(b\).
        This step is justified by the (computational) IND-CPA security of the underlying PKE \(\PKE'\) because neither the secret key \(\sk'_1\) nor the randomness \(r^*_1\) are used (except to generate \(c^*_1\)).
    \end{hybrids}
    Let
    \begin{bralign}
        p_i \coloneqq
        \Pr{
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                \parr{m^0,m^1} &\gets \A_1\parr{\pk}
                \\
                b &\gets \bit
                \\
                \parr{\sk\pars{c^*},c^*} &\gets \H_i\parr{\pk,\sk,m^0,m^1}
                \\
                b' &\gets \A_2\parr{\pk,c^*,\sk\pars{t^*}}
            \end{array}
            :
            b' = b
        }
    \end{bralign}
    be the probability that the adversary \(\A\) outputs the correct bit in hybrid \(i\).
    Because \(p_1\) is the adversary's advantage in the original ad-IND-CPA/CTKL security game and \(p_6 = 1/2\),
    we see
    \begin{bralign}
        p_1
        &\leq
        \abs{p_1 - p_2} + \abs{p_2 - p_3} + \abs{p_3 - p_4} + \abs{p_4 - p_5} + \abs{p_5 - p_6} + p_6
        \\
        &\leq
        \varepsilon_{\textsf{hide}}\parr{\secpar} + \varepsilon_{\textsf{WI}}\parr{\secpar} + \varepsilon_{\textsf{IND-CPA}}\parr{\secpar} + \varepsilon_{\textsf{iO}}\parr{\secpar} + \varepsilon_{\textsf{IND-CPA}}\parr{\secpar} + 1/2
        \\
        &\leq
        1/2 + \negl\parr{\secpar}
    \end{bralign}

    Note that our scheme only uses obfuscation for the punctured secret key.
\end{proof}



\begin{theorem}[Implausibility of perfect punctured key correctness]\label{thm:implausibility-of-perfect-PK-correctness}
    If there is a reduction \(\advR\) from a non-interactive assumption \(\NIA\) to the ad-IND-CPA/CCKL security of tpPKE scheme with perfect punctured key correctness,
    then \(\NIA\) does not hold.
    \marginnote{This proof also works for message-selective security.}
\end{theorem}

\begin{proof}
    We give a meta-reduction in the style of \cite{EC:Coron02}.
    Given a challenge \(C\) from the \(\NIA\) challenger,
    the meta-reduction \(\advM\) provides the reduction \(\advR\) with the challenge \(C\).
    Then the reduction \(\advR\) produces a public key \(\pk\).
    The meta-reduction in the role of the ad-IND-CPA/CCKL adversary samples two different tags \(t^*_1 \neq t^*_2 \gets T_\secpar\) and provides \(\parr{t^*_1,m^0=0,m^1=1}\) to the reduction \(\advR\).
    The reduction responds with a challenge ciphertext \(c^*_1\) and a punctured secret key \(\sk\pars{c^*_1}\).
    The meta-reduction rewinds the reduction to the point after it produced the public key and provides \(\parr{t^*_2,m^0=0,m^1=1}\) to the reduction \(\advR\).
    The reduction responds with a challenge ciphertext \(c^*_2\) and a punctured secret key \(\sk\pars{c^*_2}\).
    Now the meta-reduction decrypts \(\widetilde{m} \coloneqq \Dec\parr{\sk\pars{t^*_1},c^*_2}\) and feeds \(b' = 1 \iff \widetilde{m} = m^1\) back to the reduction as the solution of the ad-IND-CPA/CCKL adversary's challenge.
    The meta-reduction then forwards the reduction's solution to its own \(\NIA\) challenger.
    \marginnote{Analysis...}
\end{proof}


\begin{theorem}
    If there exists a perfectly sound NIWI,
    a perfectly binding commitment scheme,
    a perfectly correct obliviously samplable Chameleon hash function,
    then a perfectly correct public-coin differing input obfuscator cannot be based on a non-interactive assumption.
\end{theorem}

\begin{proof}
    The proof is the combination of \cref{thm:construction-of-perfect-PK-correctness,thm:implausibility-of-perfect-PK-correctness}.
\end{proof}