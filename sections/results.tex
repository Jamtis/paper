% !TEX root = ../paper.tex
\section{Technical Overview}
\label{sec:overview}

\begin{sitemize}
    \item \(\Gen\parr{1^\secpar} \mapsto \parr{\pk,\sk}\):
    \begin{sitemize}
        \item sample \(P',Q' \gets \Primes_\secpar\) and set \(N \coloneqq \parr{2P'+1} \parr{2Q'+1}\),
        \item sample \(\alpha \gets \pars{\parr{N-1}/4}\),
        \item sample \(g \gets \Q\R_N\),
        \item set \(X \coloneqq g^{\alpha 2^{\ell_K+\ell_T}}\),
        \item set \(\pk \coloneqq \parr{N,g,X}\),
        \item set \(\sk \coloneqq \parr{N,g,\alpha}\).
    \end{sitemize}
    
    \item \(\Enc\parr{\pk} \mapsto \parr{C,K}\):
    sample \(r \gets \pars{\parr{N-1}/4}\),
    set \(R \coloneqq g_0^{r z}\),
    set \(T \coloneqq g_0^{r 2^{\ell_{\mathsf{T}}}}\),
    set \(K \coloneqq \operatorname{BBS}_N\parr{T}\),
    set \(t \coloneqq \operatorname{T}\parr{R}\),
    set \(S \coloneqq \abs{\parr{\prod_{i=0}^d g_i^{t^i} X}^r}\),
    and set \(C \coloneqq \parr{R,S}\).
    \item \(\Punct\parr{\sk,C'_1,...,C'_d} \mapsto \sk'\):
    set \(v_i \coloneqq \operatorname{dlog}\parr{g_i}\),
    let \(V\parr{Z} \coloneqq \sum_{i=0}^d v_i Z^i\),
    set \(\delta \coloneqq \sum_{i=1}^d V\parr{t'_i}\),
    set \(\beta \coloneqq \alpha - \delta/z\),
    set \(\sk' \coloneqq \parr{\beta, \delta}\).
\end{sitemize}






























\section{iO}

\begin{theorem}[Informal]
    Let \(\PKE' = \parr{\Gen',\Enc',\Dec'}\) be a sel-IND-CPA secure PKE.
    Let \(\iO\) be an indistinguishability obfuscator.
    Let \(\NIWI = \parr{\Prove,\Verify}\) be a perfectly sound NIWI.
    Let \(\COM = \parr{\Setup,\Commit,\Open}\) be a perfectly binding commitment scheme.
    Let \(\PRF = \parr{\Gen,\Eval}\) be an injective PRF.
    \marginnote{Need strong PRF with disjoint images for different keys.}
    Then there exists an ad-IND-CTKL tpPKE \(\PKE\) with message space \(M_\secpar \coloneq \parc{0^\secpar,1^\secpar}\) and tag space \(T \coloneqq \bit^\secpar \setminus \parc{0^\secpar}\).
\end{theorem}

\begin{proof}
    Let \(m_b \coloneqq b^\secpar\).
    First, we define our ad-IND-CTKL PKE scheme and then prove correctness and security.
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\):
        \begin{sitemize}
            \item sample \(R \gets \bit^{5\secpar}\),
            \item generate \(\pp \gets \Setup\parr{^{5\secpar}}\),
            \item generate \(\parr{\pk'_1,\sk'_1}, \parr{\pk'_2,\sk'_2} \gets \Gen'\parr{1^{2\secpar}}\),
            \item generate \(C \coloneqq \Commit\parr{\pp,0^{5\secpar};R}\),
            \item set \(\pk \coloneqq \parr{\pp,\pk'_1,\pk'_2,C}\) and \(\sk \coloneqq \parr{\pk,\sk'_1}\),
            \item output \(\parr{\pk,\sk}\).
        \end{sitemize}

        \item \(\Enc\parr{\pk,m,t}\):
        \begin{sitemize}
            \item sample \(r_1,r_2,r_{\mathsf{t}} \gets \bit^\secpar\),
            \item generate \(k \gets \Gen\parr{1^\secpar} \in \bit^\secpar\),
            \item set \(\sigma \coloneqq \Eval\parr{k;t}\),
            \item set \(c_1 \coloneqq \Enc'\parr{\pk'_1,m||k;r_1} \in \bit^{2\secpar}\),
            \item set \(c_2 \coloneqq \Enc'\parr{\pk'_2,m||k;r_2} \in \bit^{2\secpar}\),
            \item prove \(\pi \gets \Prove\parr{s_{\pk,t,\sigma,c_1,c_2},r_1,r_2,r_{\mathsf{t}}}\) where \(s_{\pk,t,\sigma,c_1,c_2}\) is following statement
            \begin{bralign}\label{eq:consistency}
                &\ \parr{
                    \exists m,k,r_1,r_2 :
                    c_1 = \Enc\parr{\pk'_1,m||k;r_1}
                    \wedge
                    c_2 = \Enc\parr{\pk'_2,m||k;r_2}
                    \wedge
                    \sigma = \Eval\parr{k,t}
                }
                \\\label{eq:trapdoor}
                \vee
                &\ \parr{
                    \exists k,R :
                    C = \Commit\parr{\pp,k||c_1||c_2;R}
                    \wedge
                    \sigma = \Eval\parr{k,t}
                }
                \ ,
            \end{bralign}
            \item output \(c \coloneqq \parr{t,\sigma,c_1,c_2,\pi}\),
        \end{sitemize}
        Note that with an honestly generated public key \cref{eq:trapdoor} cannot be fulfilled.

        \item \(\Dec\parr{\sk,c}\):
        \begin{sitemize}
            \item parse \(\parr{t,c_1,c_2,\pi} \coloneqq c\),
            \item decrypt \(\widetilde{m}||\widetilde{k} \coloneqq \Dec'\parr{\sk'_1,c_1}\),
            \item if \(\Verify\parr{s_{\pk,t,\sigma,c_1,c_2},\pi} = 0\) output \(\bot\),
            \item output \(\widetilde{m}\).
        \end{sitemize}

        \item \(\Punct\parr{\sk, t'}\):
        \begin{sitemize}
            \item sample \(k' \gets \bit^\secpar\),
            \item output \(\sk\pars{t'} \gets \iO\parr{C_{\sk,t',k'}}\) where \(C_{\sk,t',k'}\) is the circuit that on input \(c = \parr{t,\sigma,c_1,c_2,\pi}\)
            \begin{sitemize}
                \item decrypts \(\widetilde{m}||\widetilde{k} \coloneqq \Dec'\parr{\sk'_1,c_1}\),
                \item if \(\Verify\parr{s_{\pk,t,\sigma,c_1,c_2},\pi} = 0\) or \(t = t'\) or \(\widetilde{k} = k'\) or \(\sigma \neq \Eval\parr{\widetilde{k},t}\), outputs \(\bot\),
                \item outputs \(\widetilde{m}\).
            \end{sitemize}
        \end{sitemize}

        \item \(\Dec\parr{\sk\pars{t'},c}\):
        \begin{sitemize}
            \item output \(\sk\pars{t'}\parr{c}\).
        \end{sitemize}
    \end{sitemize}
    Now, let's prove ad-IND-CTKL security of our scheme.
    For simple exhibition we assume that the underlying PKE is perfectly correct and the commitment scheme is perfectly binding.
    For statistical security we would have to add the negligible probability that the generation algorithms \(\Gen'\) and \(\Setup\) output \enquote{faulty} parameters.
    \begin{hybrids}
        \item This is the original ad-IND-CTKL with a uniformly random bit \(b \gets \bit\).
        In particular, the challenge ciphertext is \(c^* = \parr{t^*,\sigma^*,c^*_1,c^*_2,\pi^*}\).

        \item We abort iff \(k' = k^*\)
        This condition only occurs with probability \(2^{-\secpar}\).

        \item We set \(C_1 \coloneqq \Commit\parr{\pp,k'||c^*_1||c^*_2;R}\).
        This step is justified by the (computational) hiding property of the commitment scheme because the randomness \(R\) is only used to generate \(C\).

        \item We prove \(\pi^* \gets \Prove\parr{s_{\pk,t^*,h^*,c^*_1,c^*_2},w}\) using as witness \(w \coloneqq \parr{k',R}\) instead of \(\parr{m_b,k^*,r^*_1,r^*_2}\).
        Note that now \cref{eq:trapdoor} is fulfilled instead of \cref{eq:consistency} and the randomness \(r^*_2\) is only used to generate \(c^*_2\).
        Also, \(\sk'_2\) is not used anymore, though \(\sk'_1\) is used in the obfuscation \(\sk\pars{t^*}\).
        This step is justified by the (computational) witness indistinguishability of the NIWI.

        \item We set \(c^*_2 \gets \Enc\parr{\pk'_2,0^\secpar||k';r^*_2}\) instead of \(\Enc\parr{\pk'_2,m_b||k^*;r^*_2}\).
        This step is justified by the (computational) IND-CPA security of the underlying PKE \(\PKE'\) because neither the secret key \(\sk'_2\) nor the randomness \(r^*_2\) are used (except to generate \(c^*_2\)).

        \item We set \(\sk\pars{t^*} \gets \iO\parr{C'_{\sk_2,k',t^*,\sigma^*,c^*_1,c^*_2}}\) where \(C'_{\sk_2,k',t^*,\sigma^*,c^*_1,c^*_2}\) does the following on input a ciphertext \(c\):
        \begin{sitemize}
            \item parse \(\parr{t,\sigma,c_1,c_2,\pi} \coloneqq c\),
            \item decrypt \(\widetilde{m}||\widetilde{k} \coloneqq \Dec'\parr{\sk'_2,c_2}\),
            \item if \(\Verify\parr{s_{\pk,t,\sigma,c_1,c_2},\pi} = 0\) or \(t = t^*\) or \(\widetilde{k} = k'\) or \(\sigma \neq \Eval\parr{\widetilde{k},t}\) or \(c_1||c_2 = c^*_1||c^*_2\), output \(\bot\),
            \item output \(\widetilde{m}\).
        \end{sitemize}
        Now, \(\sk\pars{t^*}\) contains \(\sk'_2\) but \(\sk'_1\) is no longer used.
        This step is justified by the indistinguishability of \(\iO\) and the functional equivalence of \(C_{\sk_1,t^*,k'}\) and \(C'_{\sk_2,\sigma^*,t^*,c^*_1,c^*_2}\).
        Let us argue in detail why the two circuit are equivalent.
        First, if the verification fails \(\Verify\parr{s_{\pk,t^*,\sigma^*,c^*_1,c^*_2} = 0}\),
        then both circuits output \(\bot\).
        Thus we can concentrate on inputs (ciphertexts) where the verification passes \(\Verify\parr{s_{\pk,t^*,\sigma^*,c^*_1,c^*_2} = 1}\).
        Because of the perfect soundness of the NIWI that \cref{eq:consistency} or \cref{eq:trapdoor} or both hold.
        \begin{sitemize}
            \item If \cref{eq:consistency} holds and \cref{eq:trapdoor} doesn't hold,
            then (by perfect correctness of \(\PKE'\)) \(c_1\) and \(c_2\) contain the same plaintext \(\widetilde{m}||\widetilde{k}\) such that \(\sigma = \Eval\parr{\widetilde{k},t}\) and (by negation of \cref{eq:trapdoor}) \(c_1||c_2 \neq c^*_1||c^*_2\) or \(\sigma \neq \Eval\parr{k',t}\).
            Thus, if both circuits output some value \(\widetilde{m} \neq \bot\) it will be the same value (no matter if it is obtained by decrypting \(c_1\) or \(c_2\)).
            \\
            If \(c_1||c_2 = c^*_1||c^*_2\) both circuits output \(\bot\) on the same inputs because their abort conditions are equal.
            On the other hand \(c_1||c_2 \neq c^*_1||c^*_2\) contradicts \cref{eq:consistency} because \(c^*_1\) and \(c^*_2\) contain inconsistent plaintexts \(m_b||k^*\) and \(0^\secpar||k'\) respectively (with \(k^* \neq k'\)).

            \item If \cref{eq:trapdoor} holds, then \(c_1||c_2 = c^*_1||c^*_2\) and \(\sigma = \Eval\parr{k',t}\) because the perfectly binding commitment \(C\) contains \(k'||c^*_1||c^*_2\).
            In this case the circuit \(C'_{\sk_2,t^*,\sigma^*,c^*_1,c^*_2}\) outputs \(\bot\) because \(\widetilde{k} = k'\).
            On the other hand, \(C_{\sk_1,t^*,k'}\) outputs \(\bot\) because \(\Eval\parr{k',t} = \sigma \neq \Eval\parr{k^*,t} \impliedby k' \neq k^*\).
        \end{sitemize}

        \item We set \(c^*_1 \gets \Enc\parr{\pk'_1,0^{2\secpar};r^*_1}\) instead of \(\Enc\parr{\pk'_1,m_b||k^*;r^*_1}\).
        Note that this hybrid is independent of the bit \(b\).
        This step is justified by the (computational) IND-CPA security of the underlying PKE \(\PKE'\) because neither the secret key \(\sk'_1\) nor the randomness \(r^*_1\) are used (except to generate \(c^*_1\)).
    \end{hybrids}
    Let
    \begin{bralign}
        p_i \coloneqq
        \Pr{
            \arraycolsep=1.4pt
            \begin{array}{rl}
                \parr{\pk,\sk} &\gets \Gen\parr{1^\secpar}
                \\
                \parr{m_0,m_1,t^*} &\gets \A_1\parr{\pk}
                \\
                b &\gets \bit
                \\
                \parr{\sk\pars{t^*},c^*} &\gets \H_i\parr{\pk,\sk,m_0,m_1,t^*}
                \\
                b' &\gets \A_2\parr{\pk,c^*,\sk\pars{t^*}}
            \end{array}
            :
            b' = b
        }
    \end{bralign}
    be the probability that the adversary \(\A\) outputs the correct bit in hybrid \(i\).
    Because \(p_1\) is the adversary's advantage in the original ad-IND-CTKL security game and \(p_7 = 1/2\),
    we see
    \begin{bralign}
        p_1
        &\leq
        \abs{p_1 - p_2} + \abs{p_2 - p_3} + \abs{p_3 - p_4} + \abs{p_4 - p_5} + \abs{p_5 - p_6} + \abs{p_6 - p_7} + p_7
        \\
        &\leq
        \varepsilon_{\mathsf{hide}}\parr{\secpar} + 2^{-\secpar} + \varepsilon_{\mathsf{WI}}\parr{\secpar} + \varepsilon_{\mathsf{IND-CPA}}\parr{\secpar} + \varepsilon_{\mathsf{iO}}\parr{\secpar} + \varepsilon_{\mathsf{IND-CPA}}\parr{\secpar} + 1/2
        \\
        &\leq
        1/2 + \negl\parr{\secpar}
    \end{bralign}
\end{proof}











\begin{theorem}
    Assuming indistinguishability obfuscation,
    puncturable PRF,
    statistically binding commitment,
    and pseudorandom generator,
    there exists a deterministic statistically sound NIWI in the CRS model.
\end{theorem}

\begin{proof}
    Let \(\iO\) be an indistinguishability obfuscator,
    let \(\PPRF = \parr{\KeyGen, \Eval, \Punct}\) be a 2-puncturable,
    let \(\parr{\Commit,\Open}\) be a statistically binding commitment scheme,
    and let \(\PRG\) be a pseudorandom generator.
    \\
    We define the following \(\NIWI \coloneqq \parr{\Setup, \Prove, \Verify}\):
    \begin{sitemize}
        \item \(\Setup\parr{1^\secpar}\):
        Sample \(k_1,k_2 \gets \KeyGen\parr{1^\secpar}\).
        \\
        Let \(\mathsf{P} = \iO\parr{\parr{x, w} \mapsto \parr{\pi_0,\pi_1}}\) where \(\pi_0 \coloneqq \PRG\parr{\Eval\parr{k_1,x||w}}\) and \(\pi_1 \coloneqq \Commit\parr{w; \Eval\parr{k_2,\pi_0}}\).
        \\
        Let \(\mathsf{V} = \iO\parr{\parr{x, \pi} \mapsto R\parr{x,w} = 1 \wedge \pi_0 = \PRG\parr{\Eval\parr{k_1,x||w}}}\) where \(w \coloneqq \Open\parr{\pi_1, \Eval\parr{k_2,\pi_0}}\).

        \item \(\Prove\parr{\CRS,x,w} \coloneqq \mathsf{P}\parr{x,w}\)

        \item \(\Verify\parr{\CRS,x,\pi} \coloneqq \mathsf{V}\parr{x,\pi}\)
    \end{sitemize}

    Correctness directly follows from the correctness of the underlying primitives.
    Since the verification algorithm checks \(R\parr{x,w}\) the NIWI is perfectly (statistically) sound if the obfuscator is perfectly (statistically) correct.
    Now, we show the witness indistinguishability of \(\NIWI\) by a sequence of hybrid games.
    For simplicity we assume a perfectly binding commitment scheme.%
    \footnote{If the commitment scheme is statistically binding, then the saem argumentation applies but one has to consider the event that the scheme is not perfectly binding.}
    Let \(L \in \NP\) be language with relation \(R\).
    Let \(\hat{x} \in L\) be a statement with witnesses \(\hat{w}^0,\hat{w}^1\) s.t.\ \(\parr{\hat{x},\hat{w}^0},\parr{\hat{x},\hat{w}^1} \in R\).
    Let
    \begin{bralign}
        \mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k_1,k_2}
        \coloneqq
        \iO\parr{\parr{x,w} \mapsto \begin{cases}
            \hat{\pi}^0 & x||w = \hat{x}||\hat{w}^0
            \\
            \hat{\pi}^1 & x||w = \hat{x}||\hat{w}^1
            \\
            \pi_0 \coloneqq \PRG\parr{\Eval\parr{k_1,x||w}}, \pi_1 \coloneqq \Commit\parr{w; \Eval\parr{k_2, \pi_0}} & \text{else}\end{cases}
        }
    \end{bralign}
    and let
    \begin{bralign}
        \mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k_1,k_2}
        \coloneqq
        \iO\parr{\parr{x,\pi} \mapsto \begin{cases}
            1 & \pi = \hat{\pi}^0
            \\
            1 & \pi = \hat{\pi}^1
            \\
            R\parr{x,w} = 1 \wedge \pi_0 = \PRG\parr{\Eval\parr{k'_1,x||w}} & \text{else}
        \end{cases}}
    \end{bralign}
    where \(w \coloneqq \Open\parr{\pi_1, \Eval\parr{k_2,\pi_0}}\).
    \begin{hybrids}
        \item Sample \(\CRS \gets \Setup\parr{1^\secpar}\).
        Let \(\pi^* \coloneqq \mathsf{P}\parr{\hat{x}||\hat{w}^0}\).
        Output \(\parr{\CRS, \pi^*}\).
        Note that this hybrid corresponds to the honest proving only uses the witness \(\hat{w}^0\).

        \item Let \(k'_1 \coloneqq \Punct\parr{k_1, \hat{x}||\hat{w}^0, \hat{x}||\hat{w}^1}\),
        let \(r_0^b \coloneqq \Eval\parr{k_1,\hat{x}||\hat{w}^b}\),
        let \(\hat{\pi}_0^b \coloneqq \PRG\parr{r_0^b}\),
        let \(r_1^b \coloneqq \Eval\parr{k_2,\hat{\pi}_0^b}\),
        and let \(\hat{\pi}_1^b \coloneqq \Commit\parr{\hat{w}^b; r_1^b}\) for both \(b \in \bit\).
        Let \(\CRS \coloneqq \parr{\mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}, \mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}}\).

        \item Sample \(r_0^b \gets \bit^\secpar\).

        \item Sample \(\hat{\pi}_0^b \gets \bit^{2\secpar}\).
        Denote by \(E\) the event that \(\hat{\pi}_0^0, \hat{\pi}_0^1 \not\in \PRG\parr{\bit^\secpar}\).

        \item Let \(k'_2 \coloneqq \Punct\parr{k_2, \hat{\pi}_0^0, \hat{\pi}_0^1}\).
        Let \(\CRS \coloneqq \parr{\mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k'_2}, \mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k'_2}}\).

        \item Sample \(r_1^b \gets \bit^\secpar\).

        \item Let \(\hat{\pi}_1^b \coloneqq \Commit\parr{\hat{w}^{1-b}; r_1^b}\).
        Let \(\pi^* \coloneqq \mathsf{P}\parr{\hat{x}||\hat{w}^1}\).

        \item Sample \(r_1^b \coloneqq \Eval\parr{k_2,\hat{\pi}_0^b}\).

        \item Let \(\CRS \coloneqq \parr{\mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}, \mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}}\).

        \item Let \(\hat{\pi}_0^b \coloneqq \PRG\parr{r_0^b}\).
        
        \item Let \(r_0^b \coloneqq \Eval\parr{k_1,\hat{x}||\hat{w}^b}\).
        Let \(\pi^* \coloneqq \mathsf{P}\parr{\hat{x}||\hat{w}^1}\).
        Output \(\parr{\CRS, \pi^*}\).
        Note that this hybrid corresponds to the honest proving only uses the witness \(\hat{w}^1\).
    \end{hybrids}
    For any PPT distinguisher \(\D\) consider the probability \(\varepsilon_i \coloneqq \Pr[{\parr{\CRS,\pi^*} \gets \H_i}]{\D\parr{\CRS,\pi^*} = 0}\) that the distinguisher outputs \(0\) in hybrid \(i\).
    \\
    Because the circuits \(\mathsf{P}\) and \(\mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}\), and \(\mathsf{V}\) and \(\mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}\) are functionally equivalent it follows that \(\abs{\varepsilon_1 - \varepsilon_2} \leq \eta_{\iO}\parr{\secpar}\).
    Because \(\H_2\) and \(\H_3\) only use \(k_1\) to compute \(r_0^b\) it follows that \(\abs{\varepsilon_2 - \varepsilon_3} \leq \eta_{\PPRF}\parr{\secpar}\) by the pseudorandomness of the puncturable PRF.
    Because \(\H_3\) and \(\H_4\) use \(r_0^b\) only to compute \(\pi_0^b\) it follows that \(\abs{\varepsilon_4 - \varepsilon_4} \leq \eta_{\PRG}\parr{\secpar}\) by the pseudorandomness of the PRG.
    Note
    \begin{bralign}
        \varepsilon_4
        &=
        \underbrace{\Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{\D\parr{\CRS,\pi^*} = 0 \given E}}_{\varepsilon'_4} \underbrace{\Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{E}}_{\leq 1}
        \\
        &+
        \underbrace{\Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{\D\parr{\CRS,\pi^*} = 0 \given \text{not } E}}_{\leq 1} \underbrace{\Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{\text{not } E}}_{\leq 2^{1-\secpar}}
        \\
        &\leq
        2^{1-\secpar}
        +
        \varepsilon'_4
    \end{bralign}
    and
    \begin{bralign}
        \varepsilon_4
        &=
        \varepsilon'_4 \underbrace{\Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{E}}_{\geq 1-2^{1-\secpar}}
        +
        \Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{\D\parr{\CRS,\pi^*} = 0 \given \text{not } E} \underbrace{\Pr[{\parr{\CRS,\pi^*} \gets \H_4}]{\text{not } E}}_{\geq 0}
        \\
        &\geq
        \varepsilon'_4 \parr{1-2^{1-\secpar}}
        \ ,
    \end{bralign}
    hence \(\abs{\varepsilon_4 - \varepsilon'_4} \leq 2^{1-\secpar}\).
    The event \(E\) implies that the circuits \(\mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}\) and \(\mathsf{P}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k'_2}\) are functionally equivalent because \(\Eval\) only gets called on PRG images and \(k'_2\) in punctured at a non-PRG image.
    Moreover, \(E\) implies that the circuits \(\mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k_2}\) and \(\mathsf{V}_{\hat{\pi}^0,\hat{\pi}^1,k'_1,k'_2}\) are functionally equivalent.
    Specifically, on input \(\hat{x}||\hat{\pi}^b\) both circuits outputs \(1\).
    On the other hand for any input \(\hat{x}||\widetilde{\pi}_0^b||\hat{\pi}_1^b\) with \(\widetilde{\pi}_0^b \neq \hat{\pi}_0^b\) the outputs is \(0\) because the recovered \(w \coloneqq \Open\parr{\hat{\pi}_1^b, \Eval\parr{k'_2,\widetilde{\pi}_0^b}} = \bot\) (this follows from the prefect binding property of the commitment) will never satisfy the relation \(R\).
    Consequently, \(\abs{\varepsilon'_4 - \varepsilon'_5} \leq \eta_{\iO}\parr{\secpar}\) by the indistinguishability of the obfuscations.
    \\
    In \(\H_5\) the key \(k_2\) is only used to compute \(r_1^b\) and derive the key \(k'_2\) it follows \(\abs{\varepsilon'_5 - \varepsilon'_6} \leq \eta_{\PPRF}\parr{\secpar}\) by the pseudorandomness of the puncturable PRF.
\end{proof}


\subsection{Partially-Puncturable PKE}

\begin{definition}[Partially-Puncturable PKE]
    A partially-puncturable PKE (ppPKE) \(\PKE \coloneqq \parr{\Gen, \Enc_0, \Enc_1, \Dec, \Punct}\) fulfills the following properties:
    \begin{sitemize}
        \item \(\Gen\parr{1^\secpar}\) outputs a key pair \(\parr{\pk,\sk} \gets \Gen\parr{1^\secpar}\).
        \item \(\Enc\parr{\pk,m;r}\) outputs a two-part ciphertext \(c \coloneqq \parr{c_0,c_1}\).
        \item \(\Dec\parr{\sk,c}\) decrypts the ciphertext \(c\).
        \item \(\Punct\parr{\sk,c_0}\) outputs a secret-key \(\sk\pars{c_0}\) that is punctured on the first part of a ciphertext \(c_0\) s.t.\ \(\sk\pars{c_0}\) is unable to decrypt any ciphertext that has \(c_0\) as the first part.
        \item Correctness:
        \(\forall \parr{\pk,\sk} \in \Gen\ \forall m,r : \Dec\parr{\sk,\parr{c_0,c_1}}\) where \(c_0 \coloneqq \Enc_0\parr{\pk;r}\) and \(c_1 \coloneqq \Enc_1\parr{\pk,m;r}\).
        \item Correctness of punctured secret-key:
        \(\forall \parr{\pk,\sk} \in \Gen\ \forall c'_0,m,r : c_0 \neq c'_0 \implies \Dec\parr{\sk\pars{c'_0},\parr{c_0,c_1}} = m\) where \(c_0 \coloneqq \Enc_0\parr{\pk;r}\) and \(c_1 \coloneqq \Enc_1\parr{\pk,m;r}\) and \(\sk\pars{c'_0} \gets \Punct\parr{\sk,c'_0}\).
    \end{sitemize}
\end{definition}

\begin{definition}[IND-pKL security]
    A ppPKE is IND-pKL secure iff any PPT distinguisher \(\D = \parr{\D_1,\D_2}\) has negligible advantage, i.e., \(\abs{\Pr{\mathsf{EXP}^0_\D\parr{\secpar} = 0} - \Pr{\mathsf{EXP}^1_\D\parr{\secpar} = 0}} \leq \negl\parr{\secpar}\) where \(\mathsf{EXP}^b_\D\) is the following experiment:
    \begin{sitemize}
        \item sample \(\parr{\pk,\sk} \gets \Gen\parr{1^\secpar}\),
        \item sample \(r^* \gets \bit^\secpar\),
        \item sample \(b \gets \bit\),
        \item set \(\parr{m_0,m_1,\sigma} \gets \D_1\parr{1^\secpar,\pk}\),
        \item set \(c_0^* \coloneqq \Enc_0\parr{\pk;r^*}\),
        \item set \(\sk\pars{c^*_0} \coloneqq \Punct\parr{\sk,c_0^*}\),
        \item set \(c_1^* \coloneqq \Enc_1\parr{\pk,m_b;r^*}\),
        \item set \(b' \gets \D_2\parr{\sigma,\parr{c^*_0,c^*_1},\sk\pars{c^*_0}}\),
        \item output \(b = b'\).
    \end{sitemize}
\end{definition}


\subsection{pKDM-pKL security}

\begin{definition}[pKDM-pKL security]
    A ppPKE is pKDM-pKL secure iff any PPT distinguisher \(\D\) has negligible advantage, i.e., \(\abs{\Pr{\mathsf{EXP}^0_\D\parr{\secpar} = 0} - \Pr{\mathsf{EXP}^1_\D\parr{\secpar} = 0}} \leq \negl\parr{\secpar}\) where \(\mathsf{EXP}^b_\D\) is the following experiment:
    \begin{sitemize}
        \item sample \(\parr{\pk,\sk} \gets \Gen\parr{1^\secpar}\),
        \item sample \(r^* \gets \bit^\secpar\),
        \item sample \(b \gets \bit\),
        \item set \(c_0^* \coloneqq \Enc_0\parr{\pk;r^*}\),
        \item set \(\sk\pars{c^*_0} \coloneqq \Punct\parr{\sk,c_0^*}\),
        \item set \(m_0 \coloneqq 0\) and \(m_1 \coloneqq \sk\pars{c^*_0}\),
        \item set \(c_1^* \coloneqq \Enc_1\parr{\pk,m_b;r^*}\),
        \item set \(b' \gets \D\parr{1^\secpar,\pk,\parr{c^*_0,c^*_1},\sk\pars{c^*_0}}\),
        \item output \(b = b'\).
    \end{sitemize}
\end{definition}

\begin{lemma}
    Let \(\PKE \coloneqq \parr{\Gen, \Enc, \Dec}\) be a IND-CPA secure PKE scheme.
    Let \(\PKE' \coloneqq \parr{\Gen', \Enc'_0, \Enc'_1, \Dec', \Punct'}\) be a ppPKE.
    Then there exists a pKDM-pKL secure ppPKE \(\overline{\PKE} \coloneqq \parr{\overline{\Gen}, \overline{\Enc}_0, \overline{\Enc}_1, \overline{\Dec}, \overline{\Punct}}\).
\end{lemma}

\begin{proof}
    We first give a construction and then prove its security.
    \paragraph{Construction.}
    \begin{sitemize}
        \item \(\overline{\Gen}\parr{1^\secpar;r}\):
        output \(\parr{\overline{\pk},\overline{\sk}} \coloneqq \parr{\pk',\sk'} = \Gen'\parr{1^\secpar;r}\).

        \item \(\overline{\Enc}_0\parr{\overline{\pk};r}\):
        parse \(\parr{r_0,r_1,r_{\Gen}} \coloneqq r\),
        set \(\parr{\pk,\sk} \coloneqq \Gen\parr{1^\secpar;r_{\Gen}}\),
        output \(\overline{c}_0 \coloneqq \Enc'_0\parr{\pk';r_0}\).

        \item \(\overline{\Enc}_1\parr{\overline{\pk},m;r}\):
        parse \(\parr{r_0,r_1,r_{\Gen}} \coloneqq r\),
        set \(\parr{\pk,\sk} \gets \Gen\parr{1^\secpar;r_{\Gen}}\),
        set \(c'_1 \coloneqq \Enc'_1\parr{\pk',\sk;r_0}\),
        set \(c \coloneqq \Enc\parr{\pk,m;r_1}\),
        output \(\overline{c}_1 \coloneqq \parr{c'_1,c}\).

        \item \(\overline{\Dec}\parr{\overline{\sk},\overline{c}}\):
        parse \(\parr{c'_0,c'_1,c} \coloneqq \overline{c}\),
        decrypt \(\sk \coloneqq \Dec'\parr{\sk',\parr{c'_0,c'_1}}\),
        output \(m \coloneqq \Dec\parr{\sk,c}\).

        \item \(\overline{\Punct}\parr{\overline{\sk},\overline{c}_0}\):
        output \(\sk\pars{\overline{c}_0} \coloneqq \Punct'\parr{\sk',\overline{c}_0}\).
    \end{sitemize}

    \paragraph{Security proof.}
    We prove security through four hybrid games.
    \begin{hybrids}
        \item Sample \(\parr{\overline{\pk},\overline{\sk}} \gets \overline{\Gen}\parr{1^\secpar}\),
        sample \(r \gets \bit^\secpar\),
        set \(\overline{c}^*_0 \coloneqq \overline{\Enc}_0\parr{\pk;r}\),
        set \(\sk\pars{c^*_0} \coloneqq \Punct\parr{\sk,c^*_0}\),
        set \(m_0 \coloneqq 0\) and \(m_1 \coloneqq \sk\pars{c^*_0}\),
        sample \(b \gets \bit\),
        set \(\overline{c}^*_1 \coloneqq \overline{\Enc}_1\parr{\pk,m_b;r}\),
        output \(\parr{\overline{\pk},\overline{c}^*,\sk\pars{c^*_0}}\).

        \item Sample \(\parr{\overline{\pk},\overline{\sk}} \gets \overline{\Gen}\parr{1^\secpar}\),
        sample \(r = \parr{r_0,r_1,r_{\Gen}} \gets \bit^\secpar\),
        set \(\overline{c}^*_0 \coloneqq \overline{\Enc}_0\parr{\pk;r}\),
        set \(\sk\pars{c^*_0} \coloneqq \Punct\parr{\sk,c^*_0}\),
        set \(m_0 \coloneqq 0\) and \(m_1 \coloneqq \sk\pars{c^*_0}\),
        sample \(b \gets \bit\),
        set \(c'_1 \coloneqq \Enc'_1\parr{\pk',\fbox{\sk};r_0}\),
        set \(c \coloneqq \Enc\parr{\pk,m_b;r_1}\),
        set \(\overline{c}^* \coloneqq \parr{\overline{c}^*_0, c'_1, c}\),
        output \(\parr{\overline{\pk},\overline{c}^*,\sk\pars{c^*_0}}\).

        \item Sample \(\parr{\overline{\pk},\overline{\sk}} \gets \overline{\Gen}\parr{1^\secpar}\),
        sample \(r = \parr{r_0,r_1,r_{\Gen}} \gets \bit^\secpar\),
        set \(\overline{c}^*_0 \coloneqq \overline{\Enc}_0\parr{\pk;r}\),
        set \(\sk\pars{c^*_0} \coloneqq \Punct\parr{\sk,c^*_0}\),
        set \(m_0 \coloneqq 0\) and \(m_1 \coloneqq \sk\pars{c^*_0}\),
        sample \(b \gets \bit\),
        set \(c'_1 \coloneqq \Enc'_1\parr{\pk',\fbox{0};r_0}\),
        set \(c \coloneqq \Enc\parr{\pk,\fbox{\(m_b\)};r_1}\),
        set \(\overline{c}^* \coloneqq \parr{\overline{c}^*_0, c'_1, c}\),
        output \(\parr{\overline{\pk},\overline{c}^*,\sk\pars{c^*_0}}\).

        \item Sample \(\parr{\overline{\pk},\overline{\sk}} \gets \overline{\Gen}\parr{1^\secpar}\),
        sample \(r = \parr{r_0,r_1,r_{\Gen}} \gets \bit^\secpar\),
        set \(\overline{c}^*_0 \coloneqq \overline{\Enc}_0\parr{\pk;r}\),
        set \(\sk\pars{c^*_0} \coloneqq \Punct\parr{\sk,c^*_0}\),
        set \(m_0 \coloneqq 0\) and \(m_1 \coloneqq \sk\pars{c^*_0}\),
        set \(c'_1 \coloneqq \Enc'_1\parr{\pk',0;r_0}\),
        set \(c \coloneqq \Enc\parr{\pk,\fbox{0};r_1}\),
        set \(\overline{c}^* \coloneqq \parr{\overline{c}^*_0, c'_1, c}\),
        output \(\parr{\overline{\pk},\overline{c}^*,\sk\pars{c^*_0}}\).
    \end{hybrids}
    First, note that the output distribution of \(\H_1\) is the same as in the original pKDM-pKL security game.
    The distribution of \(\H_2\) is distributionally equal to the one of \(\H_1\).
    The indistinguishability between \(\H_3\) and \(\H_2\) follows from the IND-pKDM security of \(\PKE'\).
    The indistinguishability between \(\H_4\) and \(\H_3\) follows from the IND-CPA security of \(\PKE\).
    Lastly, the distribution of \(\H_4\) is independent of the choice bit \(b\).
\end{proof}



\begin{lemma}
    Let \(\FHE \coloneqq \parr{\Gen, \Enc, \Dec, \Eval}\) be a IND-CPA secure FHE scheme for \(\NC[1]\).
    Let \(\PKE' \coloneqq \parr{\Gen', \Enc'_0, \Enc'_1, \Dec', \Punct'}\) be a ppPKE.
    Then there exists a pKDM-pKL secure ppFHE \(\overline{\FHE} \coloneqq \parr{\overline{\Gen}, \overline{\Enc}_0, \overline{\Enc}_1, \overline{\Dec}, \overline{\Punct}, \overline{\Eval}}\) for \(\NC[1]\).
\end{lemma}
